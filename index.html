<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ライフコンパス - 体調管理</title>
    
    <!-- スマホ対応 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ライフコンパス">
    <meta name="theme-color" content="#0a0e17">
    
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&family=Orbitron:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #12182a;
            --bg-card-hover: #1a2240;
            --accent-cyan: #00d4ff;
            --accent-magenta: #ff00aa;
            --accent-gold: #ffd700;
            --accent-green: #00ff88;
            --accent-orange: #ff6b35;
            --text-primary: #e8eaf6;
            --text-secondary: #8892b0;
            --gradient-main: linear-gradient(135deg, #00d4ff 0%, #ff00aa 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Zen Kaku Gothic New', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* PWA用 - セーフエリア対応 */
        .container {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* アニメーション背景 */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: float 20s infinite ease-in-out;
        }

        .bg-orb:nth-child(1) {
            width: 400px;
            height: 400px;
            background: var(--accent-cyan);
            top: -100px;
            left: -100px;
        }

        .bg-orb:nth-child(2) {
            width: 300px;
            height: 300px;
            background: var(--accent-magenta);
            bottom: -50px;
            right: -50px;
            animation-delay: -10s;
        }

        .bg-orb:nth-child(3) {
            width: 200px;
            height: 200px;
            background: var(--accent-gold);
            top: 50%;
            left: 50%;
            animation-delay: -5s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -30px) scale(1.1); }
            50% { transform: translate(-30px, 50px) scale(0.9); }
            75% { transform: translate(-50px, -20px) scale(1.05); }
        }

        /* ローディング画面 */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(0, 212, 255, 0.2);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
        }

        /* 同期ステータス */
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .sync-status.synced {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .sync-status.syncing {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-cyan);
        }

        .sync-status.error {
            background: rgba(255, 0, 170, 0.2);
            color: var(--accent-magenta);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .sync-status.syncing .sync-dot {
            animation: pulse 1s infinite;
        }

        /* メインコンテナ */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ヘッダー */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(0, 212, 255, 0); }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: var(--accent-cyan);
            transform: scale(1.1);
        }

        .user-id-display {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: rgba(255,255,255,0.05);
            padding: 5px 12px;
            border-radius: 15px;
        }

        /* ステータスバー */
        .status-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .status-item {
            background: var(--bg-card);
            padding: 15px 25px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-3px);
            border-color: var(--accent-cyan);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.1);
        }

        .status-icon {
            font-size: 1.5rem;
        }

        .status-info h4 {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .level-badge {
            background: var(--gradient-main);
            padding: 5px 15px;
            border-radius: 20px;

        .app-version {
            font-size: 0.7rem;
            color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
            font-family: 'Orbitron', sans-serif;
        }
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
        }

        /* XPバー */
        .xp-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .xp-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .xp-bar {
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: var(--gradient-main);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ナビゲーションタブ */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            margin-bottom: 30px;
        }

        .nav-tab {
            padding: 10px 12px;
            background: var(--bg-card);
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: 'Zen Kaku Gothic New', sans-serif;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .nav-tab:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--gradient-main);
            color: white;
            font-weight: 500;
        }

        /* セクションコンテンツ */
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* カード */
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(0, 212, 255, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 入力フォーム */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Zen Kaku Gothic New', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ボタン */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-family: 'Zen Kaku Gothic New', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-main);
            color: white;
            font-weight: 500;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-voice {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .btn-voice.recording {
            background: var(--accent-magenta);
            border-color: var(--accent-magenta);
            color: white;
            animation: recording 1s infinite;
        }

        @keyframes recording {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 0, 170, 0.5); }
            50% { box-shadow: 0 0 0 15px rgba(255, 0, 170, 0); }
        }

        /* トレーニング */
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .exercise-btn {
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .exercise-btn:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-cyan);
        }

        .exercise-btn.selected {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--accent-cyan);
        }

        .exercise-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .exercise-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* YouTube動画リスト */
        .video-list {
            display: grid;
            gap: 15px;
        }

        .video-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .video-item:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(5px);
        }

        .video-thumb {
            width: 160px;
            height: 90px;
            background: var(--bg-card);
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .video-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-info {
            flex: 1;
        }

        .video-title {
            font-weight: 500;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .video-duration {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .video-category {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--accent-cyan);
            margin-top: 8px;
        }

        .video-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 0, 170, 0.2);
            border: none;
            color: var(--accent-magenta);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-item:hover .video-delete {
            opacity: 1;
        }

        /* 食事タイプボタン */
        .meal-type-btns {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .meal-type-btn {
            flex: 1;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .meal-type-btn:hover {
            border-color: var(--accent-orange);
        }

        .meal-type-btn.selected {
            background: rgba(255, 107, 53, 0.2);
            border-color: var(--accent-orange);
        }

        /* 履歴リスト */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.3s ease;
        }

        .history-item:hover {
            background: rgba(255,255,255,0.03);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .history-content {
            flex: 1;
            margin: 0 20px;
        }

        .history-xp {
            color: var(--accent-gold);
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
        }

        /* 履歴コントロール */
        .history-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .history-search input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .history-search input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .history-filters {
            display: flex;
            gap: 10px;
        }

        .history-filters select,
        .history-filters input[type="date"] {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* 表示切替タブ */
        .history-view-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.03);
            padding: 5px;
            border-radius: 10px;
        }

        .history-view-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .history-view-tab.active {
            background: var(--accent-cyan);
            color: white;
        }

        /* 履歴アイテム改善 */
        .history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .history-item-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        .history-item-main {
            flex: 1;
            margin-left: 15px;
        }

        .history-item-title {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .history-item-subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .history-item-meta {
            text-align: right;
        }

        .history-item-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .history-item-xp {
            color: var(--accent-gold);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
        }

        /* カレンダー表示 */
        .history-calendar {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header span {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .calendar-weekdays div:first-child {
            color: #ff6b6b;
        }

        .calendar-weekdays div:last-child {
            color: #4dabf7;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .calendar-day.today {
            border: 2px solid var(--accent-cyan);
        }

        .calendar-day.has-records {
            background: rgba(0, 255, 136, 0.15);
        }

        .calendar-day.has-records::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 6px;
            height: 6px;
            background: var(--accent-green);
            border-radius: 50%;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        /* 日別サマリー */
        .daily-summary-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .daily-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .daily-summary-date {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .daily-summary-stats {
            display: flex;
            gap: 15px;
        }

        .daily-summary-stat {
            text-align: center;
        }

        .daily-summary-stat-value {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-cyan);
        }

        .daily-summary-stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .daily-summary-records {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .daily-summary-record {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* モーダルフッター */
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b81 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 71, 87, 0.3);
        }

        /* 記録詳細 */
        .record-detail-grid {
            display: grid;
            gap: 15px;
        }

        .record-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .record-detail-label {
            color: var(--text-secondary);
        }

        .record-detail-value {
            font-weight: 500;
        }

        /* 編集フォーム */
        .edit-form-group {
            margin-bottom: 15px;
        }

        .edit-form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .edit-form-group input,
        .edit-form-group textarea,
        .edit-form-group select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
        }

        /* 実績バッジ */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .badge {
            text-align: center;
            padding: 20px 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .badge.unlocked {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--accent-gold);
        }

        .badge.locked {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .badge-name {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* グラフエリア */
        .chart-container {
            height: 250px;
            margin-top: 20px;
        }

        .chart-placeholder {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 5px;
        }

        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 200px;
            padding: 0 10px;
        }

        .chart-bar {
            flex: 1;
            background: var(--gradient-main);
            border-radius: 5px 5px 0 0;
            min-height: 10px;
            transition: height 0.5s ease;
            position: relative;
        }

        .chart-bar::after {
            content: attr(data-value);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .chart-labels {
            display: flex;
            gap: 8px;
            padding: 10px;
        }

        .chart-label {
            flex: 1;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* モーダル */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .video-player {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 10px;
        }

        .video-player iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* デイリーチャレンジ */
        .challenge-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .challenge-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--accent-cyan);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .challenge-checkbox.completed {
            background: var(--accent-green);
            border-color: var(--accent-green);
        }

        .challenge-checkbox.auto {
            border-style: dashed;
            cursor: default;
            font-size: 0.7rem;
        }

        .challenge-checkbox.auto:not(.completed) {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .challenge-text {
            flex: 1;
        }

        .challenge-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .challenge-xp {
            color: var(--accent-gold);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
        }

        /* レベルアップ通知 */
        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--bg-card);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 2000;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            transition: transform 0.5s ease;
        }

        .level-up-notification.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .level-up-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: bounce 0.5s ease infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        .level-up-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 音声認識フィードバック */
        .voice-feedback {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            padding: 15px 30px;
            border-radius: 50px;
            display: none;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--accent-cyan);
            z-index: 100;
        }

        .voice-feedback.active {
            display: flex;
        }

        .voice-waves {
            display: flex;
            gap: 3px;
            height: 20px;
            align-items: center;
        }

        .voice-wave {
            width: 4px;
            background: var(--accent-cyan);
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite alternate;
        }

        .voice-wave:nth-child(1) { height: 8px; animation-delay: 0s; }
        .voice-wave:nth-child(2) { height: 15px; animation-delay: 0.1s; }
        .voice-wave:nth-child(3) { height: 20px; animation-delay: 0.2s; }
        .voice-wave:nth-child(4) { height: 15px; animation-delay: 0.3s; }
        .voice-wave:nth-child(5) { height: 8px; animation-delay: 0.4s; }

        @keyframes wave {
            from { transform: scaleY(1); }
            to { transform: scaleY(0.5); }
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .status-bar {
                flex-direction: column;
            }

            .video-item {
                flex-direction: column;
            }

            .video-thumb {
                width: 100%;
                height: 180px;
            }

            .exercise-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .badges-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .header-right {
                flex-direction: column;
                align-items: flex-end;
                gap: 8px;
            }
        }

        /* スクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
        }

        /* GPXアップロードエリア */
        .gpx-upload-area {
            border: 2px dashed rgba(0, 212, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .gpx-upload-area:hover,
        .gpx-upload-area.dragover {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.1);
        }

        .gpx-upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .gpx-result {
            padding: 20px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 15px;
            margin-top: 20px;
        }

        .gpx-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .gpx-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .gpx-stat-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .gpx-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-cyan);
        }

        /* 登山履歴 */
        .hiking-history {
            max-height: 400px;
            overflow-y: auto;
        }

        .hiking-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            align-items: center;
        }

        .hiking-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hiking-info {
            flex: 1;
        }

        .hiking-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .hiking-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .hiking-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* 筋トレメニュー */
        .strength-menu {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .strength-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
        }

        .strength-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .strength-item:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .strength-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-cyan);
        }

        /* お酒グリッド */
        .alcohol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .alcohol-btn {
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alcohol-btn:hover {
            background: rgba(255, 107, 53, 0.1);
            border-color: var(--accent-orange);
        }

        .alcohol-btn.selected {
            background: rgba(255, 107, 53, 0.2);
            border-color: var(--accent-orange);
        }

        .alcohol-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .alcohol-name {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .alcohol-unit {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .alcohol-summary {
            margin-bottom: 20px;
        }

        .alcohol-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .alcohol-stat-value {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-orange);
            font-weight: 600;
        }

        /* お気に入りリンク */
        .favorite-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .favorite-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text-primary);
            position: relative;
        }

        .favorite-btn:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .favorite-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .favorite-name {
            font-size: 0.75rem;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }

        .favorite-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            background: var(--accent-magenta);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .favorite-btn:hover .favorite-delete {
            display: flex;
        }

        .add-favorite-form {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .emoji-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .emoji-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.3rem;

        /* Google Fit連携 */
        .google-fit-section {
            margin-bottom: 20px;
            text-align: center;
        }

        .btn-google-fit {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            background: linear-gradient(135deg, #4285F4 0%, #34A853 50%, #FBBC05 100%);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .btn-google-fit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }

        .btn-google-fit:active {
            transform: translateY(0);
        }

        .btn-google-fit.connected {
            background: linear-gradient(135deg, #34A853 0%, #0F9D58 100%);
        }

        .btn-google-fit.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .google-fit-status {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .google-fit-status.success {
            color: var(--accent-green);
        }

        .google-fit-status.error {
            color: #ff6b6b;
        }

        .divider-text {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 15px 0;
            position: relative;
        }

        .divider-text::before,
        .divider-text::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .divider-text::before {
            left: 0;
        }

        .divider-text::after {
            right: 0;
        }

        /* バイタル記録 */
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .vital-input-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .vital-input-card:focus-within {
            border: 1px solid var(--accent-cyan);
            background: rgba(0, 212, 255, 0.05);
        }

        .vital-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .vital-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .vital-input-card input {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: var(--text-primary);
            text-align: center;
            font-size: 1.1rem;
            font-family: 'Orbitron', sans-serif;
        }

        .vital-unit {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
            margin-top: 5px;
        }

        /* BMI計算 */
        .bmi-calculator {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .bmi-result {
            width: 100px;
            height: 100px;
            background: var(--gradient-main);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .bmi-value {
            font-size: 1.8rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
        }

        .bmi-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .bmi-stats {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bmi-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .bmi-stat-label {
            color: var(--text-secondary);
        }

        .bmi-stat-value {
            font-weight: 500;
            color: var(--accent-cyan);
        }

        /* ダイエットメニュー */
        .diet-settings {
            margin-bottom: 20px;
        }

        .diet-result {
            margin-top: 20px;
        }

        .diet-menu-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .diet-day {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
        }

        .diet-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .diet-day-title {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diet-day-calories {
            font-size: 0.85rem;
            color: var(--accent-cyan);
            font-family: 'Orbitron', sans-serif;
        }

        .diet-meals {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .diet-meal {
            display: flex;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .diet-meal-type {
            font-size: 1.2rem;
            width: 30px;
        }

        .diet-meal-content {
            flex: 1;
        }

        .diet-meal-name {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .diet-meal-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .diet-loading {
            text-align: center;
            padding: 40px;
        }

        .diet-history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .diet-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .diet-history-item:hover {
            background: rgba(0, 212, 255, 0.1);
            transform: translateX(5px);
        }

        .diet-history-info {
            flex: 1;
        }

        .diet-history-date {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .diet-history-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .diet-history-arrow {
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .shopping-list-category {
            margin-bottom: 20px;
        }

        .shopping-list-title {
            font-weight: 500;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shopping-list-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .shopping-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .shopping-list-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-cyan);
        }
            transition: all 0.2s ease;
        }

        .emoji-option:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .emoji-option.selected {
            background: rgba(0, 212, 255, 0.3);
            border: 2px solid var(--accent-cyan);
        }

        /* リマインダー */
        .reminder-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .reminder-status {
            margin-bottom: 20px;
        }

        .reminder-permission {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid var(--accent-orange);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .reminder-permission p {
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .reminder-permission.granted {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--accent-green);
        }

        .reminder-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .reminder-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .reminder-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .reminder-time {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            color: var(--accent-cyan);
            min-width: 70px;
        }

        .reminder-info {
            flex: 1;
        }

        .reminder-category {
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .reminder-days {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .reminder-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reminder-toggle.active {
            background: var(--accent-green);
        }

        .reminder-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .reminder-toggle.active::after {
            left: 26px;
        }

        .reminder-delete {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0.5;
            transition: all 0.2s ease;
        }

        .reminder-delete:hover {
            color: var(--accent-magenta);
            opacity: 1;
        }

        .add-reminder-form {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
        }

        .weekday-picker {
            display: flex;
            gap: 8px;
        }

        .weekday-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .weekday-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .weekday-btn.selected {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .sound-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sound-option {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sound-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sound-option input[type="radio"] {
            accent-color: var(--accent-cyan);
        }

        /* 通知ポップアップ */
        .notification-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
            border: 2px solid var(--accent-cyan);
            border-radius: 20px;
            padding: 30px;
            z-index: 10000;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.3);
            max-width: 90%;
            width: 350px;
        }

        .notification-popup.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .notification-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: bounce 0.5s ease infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        .notification-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent-cyan);
        }

        .notification-message {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .notification-time {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: var(--accent-magenta);
            margin-bottom: 20px;
        }

        .notification-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* AI分析 */
        .analysis-date {
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-cyan);
        }

        .analysis-summary {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analysis-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .analysis-summary-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .analysis-summary-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .analysis-summary-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .analysis-summary-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--accent-cyan);
        }

        .analysis-actions {
            text-align: center;
        }

        .analysis-result {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            line-height: 1.8;
        }

        .analysis-result h4 {
            color: var(--accent-cyan);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-result p {
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .analysis-result ul {
            list-style: none;
            padding: 0;
        }

        .analysis-result li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .analysis-result li:last-child {
            border-bottom: none;
        }

        .analysis-score {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .analysis-score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
        }

        .analysis-score-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .analysis-score-label {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .score-excellent {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: var(--bg-primary);
        }

        .score-good {
            background: linear-gradient(135deg, #00d4ff, #8b5cf6);
            color: white;
        }

        .score-average {
            background: linear-gradient(135deg, #ff6b35, #fbbf24);
            color: var(--bg-primary);
        }

        .score-low {
            background: linear-gradient(135deg, #ef4444, #ff6b35);
            color: white;
        }

        .analysis-calendar {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .btn-calendar {
            background: linear-gradient(135deg, #4285f4, #34a853);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-calendar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(66, 133, 244, 0.4);
        }

        .calendar-icon {
            font-size: 1.2rem;
        }

        .api-key-input {
            display: flex;
            gap: 10px;
        }

        .api-key-input input {
            flex: 1;
        }

        .analysis-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .analysis-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .analysis-history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .analysis-history-date {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-cyan);
        }

        .analysis-history-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-loading {
            text-align: center;
            padding: 40px;
        }

        .analysis-loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 212, 255, 0.2);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* フローティングカレンダーボタン */
        .floating-calendar-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4285f4, #34a853);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 1.8rem;
            box-shadow: 0 4px 20px rgba(66, 133, 244, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .floating-calendar-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(66, 133, 244, 0.6);
        }

        .floating-calendar-btn:active {
            transform: scale(0.95);
        }

        /* PWA インストールバナー */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #12182a 0%, #1a2240 100%);
            border-top: 1px solid var(--accent-cyan);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2000;
            animation: slideUp 0.3s ease;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .install-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .install-icon {
            font-size: 2rem;
        }

        .install-text {
            display: flex;
            flex-direction: column;
        }

        .install-text strong {
            color: var(--text-primary);
        }

        .install-text small {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .install-buttons {
            display: flex;
            gap: 10px;
        }

        .install-btn-later {
            background: transparent;
            border: 1px solid var(--text-secondary);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .install-btn-add {
            background: var(--gradient-main);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* スマホ対応 */
        @media (max-width: 600px) {
            .floating-calendar-btn {
                bottom: 20px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.5rem;
            }

            .install-banner {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .install-content {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- ローディング画面 -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">データを読み込み中...</div>
    </div>

    <div class="bg-animation">
        <div class="bg-orb"></div>
        <div class="bg-orb"></div>
        <div class="bg-orb"></div>
    </div>

    <!-- 同期ステータス -->
    <div class="sync-status synced" id="syncStatus">
        <div class="sync-dot"></div>
        <span id="syncText">同期済み</span>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">🧭</div>
                ライフコンパス
            </div>
            <div class="header-right">
                <span class="app-version">v5.3</span>
                <a href="https://calendar.google.com/" target="_blank" class="header-btn" title="Googleカレンダーを開く">📅</a>
                <div class="user-id-display">ID: <span id="userIdDisplay">---</span></div>
                <div class="level-badge">Lv.<span id="currentLevel">1</span></div>
            </div>
        </header>

        <!-- ステータスバー -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-icon">🔥</span>
                <div class="status-info">
                    <h4>連続記録</h4>
                    <div class="status-value"><span id="streakDays">0</span>日</div>
                </div>
            </div>
            <div class="status-item">
                <span class="status-icon">👣</span>
                <div class="status-info">
                    <h4>今日の歩数</h4>
                    <div class="status-value"><span id="todaySteps">0</span></div>
                </div>
            </div>
            <div class="status-item">
                <span class="status-icon">⚖️</span>
                <div class="status-info">
                    <h4>体重</h4>
                    <div class="status-value"><span id="currentWeight">--</span>kg</div>
                </div>
            </div>
            <div class="status-item">
                <span class="status-icon">🏆</span>
                <div class="status-info">
                    <h4>獲得バッジ</h4>
                    <div class="status-value"><span id="badgeCount">0</span></div>
                </div>
            </div>
        </div>

        <!-- XPバー -->
        <div class="xp-container">
            <div class="xp-header">
                <span>経験値</span>
                <span><span id="currentXP">0</span> / <span id="nextLevelXP">100</span> XP</span>
            </div>
            <div class="xp-bar">
                <div class="xp-fill" id="xpFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- 日々のチャレンジ -->
        <div class="card daily-challenges">
            <div class="card-header">
                <h3 class="card-title">📋 今日のチャレンジ</h3>
            </div>
            <div id="challengeList"></div>
        </div>

        <!-- ナビゲーション -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="training">🏋️ トレーニング</button>
            <button class="nav-tab" data-tab="hiking">🥾 登山</button>
            <button class="nav-tab" data-tab="exercise">🧘 軽い運動</button>
            <button class="nav-tab" data-tab="meal">🍽️ 食事</button>
            <button class="nav-tab" data-tab="alcohol">🍺 お酒</button>
            <button class="nav-tab" data-tab="steps">👣 歩数</button>
            <button class="nav-tab" data-tab="vitals">💓 バイタル</button>
            <button class="nav-tab" data-tab="pastRecord">📅 過去の記録</button>
            <button class="nav-tab" data-tab="other">📝 その他</button>
            <button class="nav-tab" data-tab="favorites">⭐ お気に入り</button>
            <button class="nav-tab" data-tab="reminders">⏰ アラート</button>
            <button class="nav-tab" data-tab="analysis">🤖 AI分析</button>
            <button class="nav-tab" data-tab="badges">🏆 実績</button>
            <button class="nav-tab" data-tab="history">📊 履歴</button>
        </div>

        <!-- トレーニングセクション -->
        <div class="section active" id="training">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">💪 トレーニング記録</h3>
                    <button class="btn-voice" id="voiceTraining" title="音声入力">🎤</button>
                </div>
                <div class="exercise-grid" id="exerciseGrid">
                    <div class="exercise-btn" data-exercise="筋トレ">
                        <div class="exercise-icon">🏋️</div>
                        <div class="exercise-name">筋トレ</div>
                    </div>
                    <div class="exercise-btn" data-exercise="ランニング">
                        <div class="exercise-icon">🏃</div>
                        <div class="exercise-name">ランニング</div>
                    </div>
                    <div class="exercise-btn" data-exercise="サイクリング">
                        <div class="exercise-icon">🚴</div>
                        <div class="exercise-name">サイクリング</div>
                    </div>
                    <div class="exercise-btn" data-exercise="水泳">
                        <div class="exercise-icon">🏊</div>
                        <div class="exercise-name">水泳</div>
                    </div>
                    <div class="exercise-btn" data-exercise="ヨガ">
                        <div class="exercise-icon">🧘</div>
                        <div class="exercise-name">ヨガ</div>
                    </div>
                    <div class="exercise-btn" data-exercise="登山">
                        <div class="exercise-icon">🥾</div>
                        <div class="exercise-name">登山</div>
                    </div>
                </div>
                
                <!-- 筋トレメニュー（筋トレ選択時に表示） -->
                <div class="strength-menu" id="strengthMenu" style="display: none;">
                    <label style="display: block; margin-bottom: 10px; color: var(--text-secondary);">筋トレメニュー（複数選択可）</label>
                    <div class="strength-grid">
                        <label class="strength-item">
                            <input type="checkbox" value="腕立て伏せ"> 腕立て伏せ
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="腹筋"> 腹筋
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="スクワット"> スクワット
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="プランク"> プランク
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="背筋"> 背筋
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="ダンベル"> ダンベル
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="懸垂"> 懸垂
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="ランジ"> ランジ
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="バーピー"> バーピー
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="ディップス"> ディップス
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="カーフレイズ"> カーフレイズ
                        </label>
                        <label class="strength-item">
                            <input type="checkbox" value="サイドプランク"> サイドプランク
                        </label>
                    </div>
                    <div class="input-row" style="margin-top: 15px;">
                        <div class="input-group" style="flex:1">
                            <label>セット数</label>
                            <input type="number" id="trainingSets" placeholder="3">
                        </div>
                        <div class="input-group" style="flex:1">
                            <label>回数/セット</label>
                            <input type="number" id="trainingReps" placeholder="10">
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>詳細・メモ</label>
                    <div class="input-row">
                        <textarea id="trainingNote" placeholder="トレーニング内容を入力..."></textarea>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group" style="flex:1">
                        <label>時間（分）</label>
                        <input type="number" id="trainingDuration" placeholder="30">
                    </div>
                    <div class="input-group" style="flex:1">
                        <label>強度</label>
                        <select id="trainingIntensity">
                            <option value="low">軽め</option>
                            <option value="medium" selected>普通</option>
                            <option value="high">ハード</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveTraining()">
                    ✨ 記録する (+20 XP)
                </button>
            </div>
        </div>

        <!-- 軽い運動セクション -->
        <div class="section" id="exercise">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🧘 仕事合間の軽い運動</h3>
                </div>
                <div class="input-group">
                    <label>YouTube動画を追加</label>
                    <input type="text" id="youtubeUrl" placeholder="YouTube URLを貼り付け">
                </div>
                <div class="input-group">
                    <label>動画の説明</label>
                    <input type="text" id="videoDescription" placeholder="例: 肩こり解消ストレッチ 5分">
                </div>
                <button class="btn btn-secondary" onclick="addYoutubeVideo()" style="margin-bottom: 20px;">動画を追加</button>
                <div class="video-list" id="videoList"></div>
            </div>
        </div>

        <!-- 登山セクション -->
        <div class="section" id="hiking">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🥾 登山記録（YAMAP GPXインポート）</h3>
                </div>
                <div class="gpx-upload-area" id="gpxUploadArea">
                    <div class="gpx-upload-icon">📁</div>
                    <p>GPXファイルをドラッグ＆ドロップ</p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary);">または</p>
                    <label class="btn btn-secondary" style="cursor: pointer; margin-top: 10px;">
                        ファイルを選択
                        <input type="file" id="gpxFileInput" accept=".gpx" style="display: none;">
                    </label>
                </div>
                <div class="gpx-result" id="gpxResult" style="display: none;">
                    <h4 style="margin-bottom: 15px;">📊 解析結果</h4>
                    <div class="gpx-stats">
                        <div class="gpx-stat">
                            <span class="gpx-stat-label">山名</span>
                            <span class="gpx-stat-value" id="gpxName">-</span>
                        </div>
                        <div class="gpx-stat">
                            <span class="gpx-stat-label">日時</span>
                            <span class="gpx-stat-value" id="gpxDate">-</span>
                        </div>
                        <div class="gpx-stat">
                            <span class="gpx-stat-label">距離</span>
                            <span class="gpx-stat-value" id="gpxDistance">-</span>
                        </div>
                        <div class="gpx-stat">
                            <span class="gpx-stat-label">累積標高（上り）</span>
                            <span class="gpx-stat-value" id="gpxElevationGain">-</span>
                        </div>
                        <div class="gpx-stat">
                            <span class="gpx-stat-label">累積標高（下り）</span>
                            <span class="gpx-stat-value" id="gpxElevationLoss">-</span>
                        </div>
                        <div class="gpx-stat">
                            <span class="gpx-stat-label">活動時間</span>
                            <span class="gpx-stat-value" id="gpxDuration">-</span>
                        </div>
                        <div class="gpx-stat">
                            <span class="gpx-stat-label">最高標高</span>
                            <span class="gpx-stat-value" id="gpxMaxElevation">-</span>
                        </div>
                        <div class="gpx-stat">
                            <span class="gpx-stat-label">最低標高</span>
                            <span class="gpx-stat-value" id="gpxMinElevation">-</span>
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 20px;">
                        <label>メモ（任意）</label>
                        <textarea id="gpxMemo" placeholder="登山の感想など..."></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="saveHikingRecord()">
                            ✨ 記録する (+30 XP)
                        </button>
                        <button class="btn btn-secondary" onclick="resetGpxUpload()">
                            キャンセル
                        </button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🏔️ 登山履歴</h3>
                </div>
                <div class="hiking-history" id="hikingHistory">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">登山記録はまだありません</p>
                </div>
            </div>
        </div>

        <!-- 食事セクション -->
        <div class="section" id="meal">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🍽️ 食事記録</h3>
                    <button class="btn-voice" id="voiceMeal" title="音声入力">🎤</button>
                </div>
                <div class="meal-type-btns">
                    <div class="meal-type-btn selected" data-meal="breakfast">🌅 朝食</div>
                    <div class="meal-type-btn" data-meal="lunch">☀️ 昼食</div>
                    <div class="meal-type-btn" data-meal="dinner">🌙 夕食</div>
                    <div class="meal-type-btn" data-meal="snack">🍪 間食</div>
                </div>
                <div class="input-group">
                    <label>食べたもの</label>
                    <textarea id="mealContent" placeholder="食事内容を入力..."></textarea>
                </div>
                <div class="input-row">
                    <div class="input-group" style="flex:1">
                        <label>カロリー（任意）</label>
                        <input type="number" id="mealCalories" placeholder="500">
                    </div>
                    <div class="input-group" style="flex:1">
                        <label>満足度</label>
                        <select id="mealSatisfaction">
                            <option value="1">😐 いまいち</option>
                            <option value="2">🙂 普通</option>
                            <option value="3" selected>😊 良い</option>
                            <option value="4">😄 とても良い</option>
                            <option value="5">🤩 最高！</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveMeal()">
                    ✨ 記録する (+10 XP)
                </button>
            </div>
        </div>

        <!-- お酒セクション -->
        <div class="section" id="alcohol">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🍺 お酒記録</h3>
                </div>
                <div class="alcohol-grid">
                    <div class="alcohol-btn" data-drink="beer" data-percent="5" data-ml="350">
                        <div class="alcohol-icon">🍺</div>
                        <div class="alcohol-name">ビール</div>
                        <div class="alcohol-unit">5% / 350ml</div>
                    </div>
                    <div class="alcohol-btn" data-drink="wine" data-percent="12" data-ml="125">
                        <div class="alcohol-icon">🍷</div>
                        <div class="alcohol-name">ワイン</div>
                        <div class="alcohol-unit">12% / 125ml</div>
                    </div>
                    <div class="alcohol-btn" data-drink="sake" data-percent="15" data-ml="180">
                        <div class="alcohol-icon">🍶</div>
                        <div class="alcohol-name">日本酒</div>
                        <div class="alcohol-unit">15% / 180ml</div>
                    </div>
                    <div class="alcohol-btn" data-drink="shochu" data-percent="25" data-ml="90">
                        <div class="alcohol-icon">🥃</div>
                        <div class="alcohol-name">焼酎</div>
                        <div class="alcohol-unit">25% / 90ml</div>
                    </div>
                    <div class="alcohol-btn" data-drink="whiskey" data-percent="40" data-ml="30">
                        <div class="alcohol-icon">🥃</div>
                        <div class="alcohol-name">ウイスキー</div>
                        <div class="alcohol-unit">40% / 30ml</div>
                    </div>
                    <div class="alcohol-btn" data-drink="highball" data-percent="7" data-ml="350">
                        <div class="alcohol-icon">🥂</div>
                        <div class="alcohol-name">ハイボール</div>
                        <div class="alcohol-unit">7% / 350ml</div>
                    </div>
                    <div class="alcohol-btn" data-drink="chuhai" data-percent="5" data-ml="350">
                        <div class="alcohol-icon">🍹</div>
                        <div class="alcohol-name">チューハイ</div>
                        <div class="alcohol-unit">5% / 350ml</div>
                    </div>
                    <div class="alcohol-btn" data-drink="cocktail" data-percent="10" data-ml="150">
                        <div class="alcohol-icon">🍸</div>
                        <div class="alcohol-name">カクテル</div>
                        <div class="alcohol-unit">10% / 150ml</div>
                    </div>
                </div>
                <div class="input-row" style="margin-top: 20px;">
                    <div class="input-group" style="flex:1">
                        <label>アルコール度数 (%)</label>
                        <input type="number" id="alcoholPercent" placeholder="5" min="0" max="100" step="0.1">
                    </div>
                    <div class="input-group" style="flex:1">
                        <label>量 (ml)</label>
                        <input type="number" id="alcoholMl" placeholder="350" min="0" step="10">
                    </div>
                </div>
                <div class="alcohol-calc" id="alcoholCalc" style="text-align: center; padding: 15px; background: rgba(255,107,53,0.1); border-radius: 10px; margin-bottom: 15px;">
                    <span style="color: var(--text-secondary);">純アルコール量: </span>
                    <span id="pureAlcohol" style="font-family: 'Orbitron', sans-serif; color: var(--accent-orange); font-size: 1.2rem;">0g</span>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">※ 1日の適量目安: 約20g</div>
                </div>
                <div class="input-row">
                    <div class="input-group" style="flex:1">
                        <label>飲んだ場所</label>
                        <select id="alcoholPlace">
                            <option value="home">🏠 自宅</option>
                            <option value="izakaya">🏮 居酒屋</option>
                            <option value="bar">🍸 バー</option>
                            <option value="restaurant">🍽️ レストラン</option>
                            <option value="friend">👥 友人宅</option>
                            <option value="other">📍 その他</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>メモ（銘柄、一緒に飲んだ人など）</label>
                    <textarea id="alcoholNote" placeholder="例: プレモル、会社の同僚と"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveAlcohol()">
                    🍻 記録する (+5 XP)
                </button>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📊 今週の飲酒量</h3>
                </div>
                <div class="alcohol-summary" id="alcoholSummary">
                    <div class="alcohol-stat-row">
                        <span>今週の純アルコール量</span>
                        <span class="alcohol-stat-value" id="weeklyAlcoholTotal">0g</span>
                    </div>
                    <div class="alcohol-stat-row">
                        <span>休肝日</span>
                        <span class="alcohol-stat-value" id="alcoholFreeDays">0 日</span>
                    </div>
                </div>
                <div class="chart-container" style="height: 200px;">
                    <div class="chart-placeholder">
                        <div class="chart-bar-container" id="alcoholChart"></div>
                        <div class="chart-labels" id="alcoholLabels"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 歩数セクション -->
        <div class="section" id="steps">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">👣 歩数記録</h3>
                    <button class="btn-voice" id="voiceSteps" title="音声入力">🎤</button>
                </div>
                
                <!-- Google Fit同期 -->
                <div class="google-fit-section">
                    <button class="btn btn-google-fit" id="googleFitBtn" onclick="handleGoogleFit()">
                        <svg viewBox="0 0 24 24" width="20" height="20" style="margin-right: 8px;">
                            <path fill="#EA4335" d="M12 11.4L6.6 6 12 .6 17.4 6z"/>
                            <path fill="#4285F4" d="M6.6 6L12 11.4v6L1.2 6z"/>
                            <path fill="#34A853" d="M12 17.4L6.6 23 12 17.4 17.4 23z"/>
                            <path fill="#FBBC05" d="M17.4 6L12 11.4v6l10.8-11.4z"/>
                        </svg>
                        <span id="googleFitBtnText">Google Fitから同期</span>
                    </button>
                    <div class="google-fit-status" id="googleFitStatus"></div>
                </div>
                
                <div class="divider-text">または手動入力</div>
                
                <div class="input-group">
                    <label>今日の歩数</label>
                    <input type="number" id="stepsInput" placeholder="10000">
                </div>
                <button class="btn btn-primary" onclick="saveSteps()">
                    ✨ 記録する (+15 XP)
                </button>
            </div>
            <div class="card">
                <h3 class="card-title">📈 週間歩数</h3>
                <div class="chart-container">
                    <div class="chart-placeholder">
                        <div class="chart-bar-container" id="stepsChart"></div>
                        <div class="chart-labels" id="stepsLabels"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 体重セクション -->
        <div class="section" id="weight">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">⚖️ 体重記録</h3>
                    <button class="btn-voice" id="voiceWeight" title="音声入力">🎤</button>
                </div>
                <div class="input-group">
                    <label>体重（kg）</label>
                    <input type="number" id="weightInput" placeholder="65.0" step="0.1">
                </div>
                <button class="btn btn-primary" onclick="saveWeight()">
                    ✨ 記録する (+10 XP)
                </button>
            </div>
            <div class="card">
                <h3 class="card-title">📈 体重推移</h3>
                <div class="chart-container">
                    <div class="chart-placeholder">
                        <div class="chart-bar-container" id="weightChart"></div>
                        <div class="chart-labels" id="weightLabels"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- その他セクション -->
        <div class="section" id="other">

        <!-- 過去の記録セクション -->
        <div class="section" id="pastRecord">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📅 過去の記録を入力</h3>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
                    記録し忘れた日のデータをまとめて入力できます
                </p>
                
                <!-- 日付選択 -->
                <div class="input-group">
                    <label>📆 記録する日付</label>
                    <input type="date" id="pastRecordDate" style="font-size: 1.1rem;">
                </div>
                
                <!-- Google Fit歩数取得 -->
                <div class="past-fit-section" style="margin: 20px 0; padding: 15px; background: rgba(66, 133, 244, 0.1); border-radius: 12px;">
                    <button class="btn btn-google-fit" id="pastGoogleFitBtn" onclick="fetchPastGoogleFitSteps()" style="width: 100%;">
                        <svg viewBox="0 0 24 24" width="20" height="20" style="margin-right: 8px;">
                            <path fill="#EA4335" d="M12 11.4L6.6 6 12 .6 17.4 6z"/>
                            <path fill="#4285F4" d="M6.6 6L12 11.4v6L1.2 6z"/>
                            <path fill="#34A853" d="M12 17.4L6.6 23 12 17.4 17.4 23z"/>
                            <path fill="#FBBC05" d="M17.4 6L12 11.4v6l10.8-11.4z"/>
                        </svg>
                        <span id="pastGoogleFitBtnText">選択した日の歩数を取得</span>
                    </button>
                    <div class="google-fit-status" id="pastGoogleFitStatus"></div>
                </div>
            </div>
            
            <!-- 歩数 -->
            <div class="card">
                <h3 class="card-title">👣 歩数</h3>
                <div class="input-group">
                    <input type="number" id="pastSteps" placeholder="歩数を入力">
                </div>
            </div>
            
            <!-- 食事 -->
            <div class="card">
                <h3 class="card-title">🍽️ 食事</h3>
                <div class="past-meal-inputs">
                    <div class="input-group">
                        <label>🌅 朝食</label>
                        <input type="text" id="pastBreakfast" placeholder="例: トースト、コーヒー">
                    </div>
                    <div class="input-group">
                        <label>☀️ 昼食</label>
                        <input type="text" id="pastLunch" placeholder="例: カレーライス">
                    </div>
                    <div class="input-group">
                        <label>🌙 夕食</label>
                        <input type="text" id="pastDinner" placeholder="例: 刺身、味噌汁">
                    </div>
                    <div class="input-group">
                        <label>🍪 間食</label>
                        <input type="text" id="pastSnack" placeholder="例: ナッツ、プロテイン">
                    </div>
                </div>
            </div>
            
            <!-- トレーニング -->
            <div class="card">
                <h3 class="card-title">🏋️ トレーニング</h3>
                <div class="input-group">
                    <label>運動の種類</label>
                    <select id="pastExerciseType">
                        <option value="">-- 選択 --</option>
                        <option value="筋トレ">🏋️ 筋トレ</option>
                        <option value="ランニング">🏃 ランニング</option>
                        <option value="ウォーキング">🚶 ウォーキング</option>
                        <option value="水泳">🏊 水泳</option>
                        <option value="ヨガ">🧘 ヨガ</option>
                        <option value="ストレッチ">🤸 ストレッチ</option>
                        <option value="サイクリング">🚴 サイクリング</option>
                        <option value="登山">🥾 登山</option>
                        <option value="その他">📋 その他</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>時間（分）</label>
                    <input type="number" id="pastExerciseDuration" placeholder="30">
                </div>
                <div class="input-group">
                    <label>メモ</label>
                    <input type="text" id="pastExerciseMemo" placeholder="例: 腕立て30回、スクワット50回">
                </div>
            </div>
            
            <!-- お酒 -->
            <div class="card">
                <h3 class="card-title">🍺 お酒</h3>
                <div class="input-group">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="pastAlcohol" value="none" checked onchange="togglePastAlcoholInputs()">
                            🍵 休肝日
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="pastAlcohol" value="drink" onchange="togglePastAlcoholInputs()">
                            🍺 飲んだ
                        </label>
                    </div>
                </div>
                <div id="pastAlcoholInputs" style="display: none;">
                    <div class="input-group">
                        <label>種類</label>
                        <select id="pastDrinkType">
                            <option value="beer">🍺 ビール</option>
                            <option value="wine">🍷 ワイン</option>
                            <option value="sake">🍶 日本酒</option>
                            <option value="shochu">🥃 焼酎</option>
                            <option value="whisky">🥃 ウイスキー</option>
                            <option value="highball">🥂 ハイボール</option>
                            <option value="chuhai">🍹 チューハイ</option>
                            <option value="other">🍸 その他</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>量（ml）</label>
                        <input type="number" id="pastDrinkAmount" placeholder="350">
                    </div>
                    <div class="input-group">
                        <label>度数（%）</label>
                        <input type="number" id="pastDrinkPercent" placeholder="5" step="0.1">
                    </div>
                </div>
            </div>
            
            <!-- 体重 -->
            <div class="card">
                <h3 class="card-title">⚖️ 体重</h3>
                <div class="input-group">
                    <input type="number" id="pastWeight" placeholder="体重（kg）" step="0.1">
                </div>
            </div>
            
            <!-- メモ -->
            <div class="card">
                <h3 class="card-title">📝 メモ</h3>
                <div class="input-group">
                    <textarea id="pastMemo" placeholder="その日の体調や出来事など..." rows="3"></textarea>
                </div>
            </div>
            
            <!-- 保存ボタン -->
            <div class="card" style="background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(255,0,170,0.1));">
                <button class="btn btn-primary" onclick="savePastRecord()" style="width: 100%; padding: 18px; font-size: 1.1rem;">
                    💾 過去の記録を保存
                </button>
                <p style="text-align: center; margin-top: 10px; color: var(--text-secondary); font-size: 0.85rem;">
                    入力した項目のみ保存されます
                </p>
            </div>
        </div>

        <!-- その他の内容 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📝 その他の記録</h3>
                    <button class="btn-voice" id="voiceOther" title="音声入力">🎤</button>
                </div>
                <div class="input-group">
                    <label>カテゴリ</label>
                    <select id="otherCategory">
                        <option value="sleep">😴 睡眠</option>
                        <option value="water">💧 水分摂取</option>
                        <option value="mood">😊 気分</option>
                        <option value="medicine">💊 薬</option>
                        <option value="other">📋 その他</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>内容</label>
                    <textarea id="otherContent" placeholder="記録内容を入力..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveOther()">
                    ✨ 記録する (+5 XP)
                </button>
            </div>

            <!-- 設定・リセット -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">⚙️ アプリ設定</h3>
                </div>
                <div class="settings-info" style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px;">
                    <p style="margin-bottom: 10px;"><strong>アプリバージョン:</strong> v5.3</p>
                    <p style="margin-bottom: 10px;"><strong>ユーザーID:</strong> <span id="settingsUserId" style="font-family: monospace; font-size: 0.85rem;">---</span></p>
                </div>
                <button class="btn btn-secondary" onclick="resetLocalData()" style="background: linear-gradient(135deg, #ff6b35, #ff00aa);">
                    🗑️ ローカルデータをリセット
                </button>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">
                    ※ お気に入り、リマインダーなどのローカル設定をリセットします。<br>
                    ※ Supabaseに保存された記録データは削除されません。
                </p>
            </div>
        </div>

        <!-- お気に入りセクション -->
        <div class="section" id="favorites">
            <!-- トレーニング動画 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🏋️ トレーニング動画</h3>
                    <span class="favorite-count" id="favoriteCountTraining">0/12</span>
                </div>
                <div class="favorites-grid" id="favoritesGridTraining"></div>
                <button class="btn btn-secondary" onclick="showAddFavoriteForm('training')" style="margin-top: 15px;">
                    ➕ 追加
                </button>
            </div>

            <!-- ストレッチ動画 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🧘 ストレッチ動画</h3>
                    <span class="favorite-count" id="favoriteCountStretch">0/12</span>
                </div>
                <div class="favorites-grid" id="favoritesGridStretch"></div>
                <button class="btn btn-secondary" onclick="showAddFavoriteForm('stretch')" style="margin-top: 15px;">
                    ➕ 追加
                </button>
            </div>

            <!-- 料理動画 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🍳 料理動画</h3>
                    <span class="favorite-count" id="favoriteCountCooking">0/12</span>
                </div>
                <div class="favorites-grid" id="favoritesGridCooking"></div>
                <button class="btn btn-secondary" onclick="showAddFavoriteForm('cooking')" style="margin-top: 15px;">
                    ➕ 追加
                </button>
            </div>

            <!-- 音楽動画 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🎵 テンション上げる音楽</h3>
                    <span class="favorite-count" id="favoriteCountMusic">0/12</span>
                </div>
                <div class="favorites-grid" id="favoritesGridMusic"></div>
                <button class="btn btn-secondary" onclick="showAddFavoriteForm('music')" style="margin-top: 15px;">
                    ➕ 追加
                </button>
            </div>

            <!-- その他リンク -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">⭐ その他のリンク</h3>
                    <span class="favorite-count" id="favoriteCountOther">0/12</span>
                </div>
                <div class="favorites-grid" id="favoritesGridOther"></div>
                <button class="btn btn-secondary" onclick="showAddFavoriteForm('other')" style="margin-top: 15px;">
                    ➕ 追加
                </button>
            </div>

            <!-- ダイエットメニュー生成 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🥗 1週間ダイエットメニュー生成</h3>
                </div>
                <div class="diet-settings">
                    <div class="input-row">
                        <div class="input-group" style="flex: 1;">
                            <label>目標カロリー（1日）</label>
                            <input type="number" id="dietCalories" placeholder="1500" value="1700">
                        </div>
                        <div class="input-group" style="flex: 1;">
                            <label>制限事項</label>
                            <select id="dietRestriction">
                                <option value="none">なし</option>
                                <option value="low_carb">低糖質</option>
                                <option value="low_fat">低脂質</option>
                                <option value="high_protein" selected>高タンパク</option>
                                <option value="vegetarian">ベジタリアン</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>好みや避けたい食材（任意）</label>
                        <input type="text" id="dietPreferences" placeholder="例: 魚が好き、乳製品アレルギー">
                    </div>
                    <button class="btn btn-primary" onclick="generateDietMenu()">
                        🤖 AIでメニューを生成
                    </button>
                </div>
                <div class="diet-result" id="dietResult" style="display: none;">
                    <div class="diet-action-buttons" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="saveDietMenu()">💾 保存する</button>
                        <button class="btn btn-secondary" onclick="generateShoppingList()">🛒 買い物リスト</button>
                    </div>
                    <div class="diet-menu-container" id="dietMenuContainer"></div>
                </div>
            </div>

            <!-- 保存したメニュー履歴 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📚 保存したメニュー</h3>
                    <span class="diet-history-count" id="dietHistoryCount">0件</span>
                </div>
                <div class="diet-history-list" id="dietHistoryList">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">保存したメニューはありません</p>
                </div>
            </div>

            <!-- 買い物リストモーダル用のコンテナ -->
            <div id="shoppingListContainer" style="display: none;"></div>
        </div>

        <!-- バイタルセクション -->
        <div class="section" id="vitals">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">💓 バイタル記録</h3>
                </div>
                <div class="vitals-grid">
                    <div class="vital-input-card">
                        <div class="vital-icon">📏</div>
                        <div class="vital-label">身長</div>
                        <input type="number" id="vitalHeight" placeholder="170" step="0.1">
                        <span class="vital-unit">cm</span>
                    </div>
                    <div class="vital-input-card">
                        <div class="vital-icon">⚖️</div>
                        <div class="vital-label">体重</div>
                        <input type="number" id="vitalWeight" placeholder="65" step="0.1">
                        <span class="vital-unit">kg</span>
                    </div>
                    <div class="vital-input-card">
                        <div class="vital-icon">📊</div>
                        <div class="vital-label">体脂肪率</div>
                        <input type="number" id="vitalBodyFat" placeholder="20" step="0.1">
                        <span class="vital-unit">%</span>
                    </div>
                    <div class="vital-input-card">
                        <div class="vital-icon">💪</div>
                        <div class="vital-label">筋肉量</div>
                        <input type="number" id="vitalMuscle" placeholder="50" step="0.1">
                        <span class="vital-unit">kg</span>
                    </div>
                </div>
                <div class="vitals-grid" style="margin-top: 15px;">
                    <div class="vital-input-card">
                        <div class="vital-icon">❤️</div>
                        <div class="vital-label">血圧（上）</div>
                        <input type="number" id="vitalBpHigh" placeholder="120">
                        <span class="vital-unit">mmHg</span>
                    </div>
                    <div class="vital-input-card">
                        <div class="vital-icon">💙</div>
                        <div class="vital-label">血圧（下）</div>
                        <input type="number" id="vitalBpLow" placeholder="80">
                        <span class="vital-unit">mmHg</span>
                    </div>
                    <div class="vital-input-card">
                        <div class="vital-icon">💗</div>
                        <div class="vital-label">心拍数</div>
                        <input type="number" id="vitalHeartRate" placeholder="70">
                        <span class="vital-unit">bpm</span>
                    </div>
                    <div class="vital-input-card">
                        <div class="vital-icon">🌡️</div>
                        <div class="vital-label">体温</div>
                        <input type="number" id="vitalTemp" placeholder="36.5" step="0.1">
                        <span class="vital-unit">℃</span>
                    </div>
                </div>
                <div class="vitals-grid" style="margin-top: 15px;">
                    <div class="vital-input-card">
                        <div class="vital-icon">🩸</div>
                        <div class="vital-label">血糖値</div>
                        <input type="number" id="vitalBloodSugar" placeholder="100">
                        <span class="vital-unit">mg/dL</span>
                    </div>
                    <div class="vital-input-card">
                        <div class="vital-icon">💧</div>
                        <div class="vital-label">SpO2</div>
                        <input type="number" id="vitalSpO2" placeholder="98">
                        <span class="vital-unit">%</span>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 20px;">
                    <label>メモ（体調など）</label>
                    <textarea id="vitalNote" placeholder="今日の体調や気になることなど..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveVitals()">
                    ✨ バイタルを記録する (+15 XP)
                </button>
            </div>

            <!-- BMI計算 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📐 BMI・基礎代謝計算</h3>
                </div>
                <div class="bmi-calculator">
                    <div class="bmi-result" id="bmiResult">
                        <div class="bmi-value">--</div>
                        <div class="bmi-label">BMI</div>
                    </div>
                    <div class="bmi-stats">
                        <div class="bmi-stat">
                            <span class="bmi-stat-label">判定</span>
                            <span class="bmi-stat-value" id="bmiStatus">--</span>
                        </div>
                        <div class="bmi-stat">
                            <span class="bmi-stat-label">基礎代謝</span>
                            <span class="bmi-stat-value" id="bmrValue">-- kcal</span>
                        </div>
                        <div class="bmi-stat">
                            <span class="bmi-stat-label">理想体重</span>
                            <span class="bmi-stat-value" id="idealWeight">-- kg</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="calculateBMI()">
                    計算する
                </button>
            </div>

            <!-- バイタル履歴グラフ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📈 バイタル推移</h3>
                    <select id="vitalChartType" onchange="renderVitalChart()">
                        <option value="weight">体重</option>
                        <option value="bodyFat">体脂肪率</option>
                        <option value="bp">血圧</option>
                        <option value="heartRate">心拍数</option>
                    </select>
                </div>
                <div class="chart-container">
                    <div class="chart-placeholder">
                        <div class="chart-bar-container" id="vitalChart"></div>
                        <div class="chart-labels" id="vitalLabels"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- アラートセクション -->
        <div class="section" id="reminders">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">⏰ リマインダー設定</h3>
                    <span class="reminder-count" id="reminderCount">0/10</span>
                </div>
                <div class="reminder-status" id="reminderStatus">
                    <div class="reminder-permission" id="reminderPermission">
                        <p>通知を受け取るには許可が必要です</p>
                        <button class="btn btn-secondary" onclick="requestNotificationPermission()">
                            🔔 通知を許可する
                        </button>
                    </div>
                </div>
                <div class="reminder-list" id="reminderList">
                    <!-- リマインダーがここに表示される -->
                </div>
                <div class="add-reminder-form">
                    <h4 style="margin-bottom: 15px;">➕ 新規リマインダー</h4>
                    <div class="input-row">
                        <div class="input-group" style="flex: 1;">
                            <label>時刻</label>
                            <input type="time" id="reminderTime" value="08:00">
                        </div>
                        <div class="input-group" style="flex: 2;">
                            <label>カテゴリ</label>
                            <select id="reminderCategory">
                                <option value="training">🏋️ トレーニング</option>
                                <option value="meal">🍽️ 食事</option>
                                <option value="steps">👣 歩数</option>
                                <option value="weight">⚖️ 体重</option>
                                <option value="water">💧 水分補給</option>
                                <option value="stretch">🧘 ストレッチ</option>
                                <option value="medicine">💊 薬</option>
                                <option value="sleep">😴 就寝</option>
                                <option value="custom">📝 カスタム</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group" id="customMessageGroup" style="display: none;">
                        <label>メッセージ</label>
                        <input type="text" id="reminderMessage" placeholder="リマインダーの内容">
                    </div>
                    <div class="input-group">
                        <label>繰り返し</label>
                        <div class="weekday-picker" id="weekdayPicker">
                            <span class="weekday-btn selected" data-day="0">日</span>
                            <span class="weekday-btn selected" data-day="1">月</span>
                            <span class="weekday-btn selected" data-day="2">火</span>
                            <span class="weekday-btn selected" data-day="3">水</span>
                            <span class="weekday-btn selected" data-day="4">木</span>
                            <span class="weekday-btn selected" data-day="5">金</span>
                            <span class="weekday-btn selected" data-day="6">土</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>アラーム音</label>
                        <div class="sound-picker">
                            <label class="sound-option">
                                <input type="radio" name="reminderSound" value="bell" checked>
                                <span>🔔 ベル</span>
                            </label>
                            <label class="sound-option">
                                <input type="radio" name="reminderSound" value="chime">
                                <span>🎵 チャイム</span>
                            </label>
                            <label class="sound-option">
                                <input type="radio" name="reminderSound" value="alert">
                                <span>⚡ アラート</span>
                            </label>
                            <label class="sound-option">
                                <input type="radio" name="reminderSound" value="none">
                                <span>🔇 なし</span>
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addReminder()">
                        ⏰ 追加する
                    </button>
                </div>
            </div>
        </div>

        <!-- AI分析セクション -->
        <div class="section" id="analysis">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🤖 今日のAI分析</h3>
                </div>
                <div class="analysis-date">
                    <span id="analysisDateDisplay"></span>
                </div>
                <div class="analysis-summary" id="analysisSummary">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                        「分析する」ボタンを押すと、今日の活動をAIが分析します
                    </p>
                </div>
                <div class="analysis-actions">
                    <button class="btn btn-primary" onclick="analyzeToday()">
                        🔍 今日を分析する
                    </button>
                </div>
            </div>
            
            <div class="card" id="analysisResultCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">📊 分析結果</h3>
                </div>
                <div class="analysis-result" id="analysisResult">
                    <!-- 分析結果がここに表示される -->
                </div>
                <div class="analysis-calendar">
                    <h4 style="margin-bottom: 15px;">📅 Googleカレンダーに追加</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
                        分析結果をカレンダーに記録して振り返りましょう
                    </p>
                    <button class="btn btn-calendar" onclick="addToGoogleCalendar()">
                        <span class="calendar-icon">📆</span>
                        Googleカレンダーに追加
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">⚙️ AI設定</h3>
                </div>
                <div class="input-group">
                    <label>Gemini API Key</label>
                    <div class="api-key-input">
                        <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
                        <button class="btn btn-secondary" onclick="toggleApiKeyVisibility()">👁️</button>
                    </div>
                    <small style="color: var(--text-secondary);">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--accent-cyan);">
                            Google AI Studioで取得 →
                        </a>
                    </small>
                </div>
                <button class="btn btn-secondary" onclick="saveApiKey()" style="margin-top: 10px;">
                    🔑 APIキーを保存
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📜 過去の分析履歴</h3>
                </div>
                <div class="analysis-history" id="analysisHistory">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">分析履歴はまだありません</p>
                </div>
            </div>
        </div>

        <!-- 実績セクション -->
        <div class="section" id="badges">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🏆 獲得した実績</h3>
                </div>
                <div class="badges-grid" id="badgesGrid"></div>
            </div>
        </div>

        <!-- 履歴セクション -->
        <div class="section" id="history">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📊 記録履歴</h3>
                </div>
                
                <!-- 検索・フィルターバー -->
                <div class="history-controls">
                    <div class="history-search">
                        <input type="text" id="historySearch" placeholder="🔍 キーワードで検索..." oninput="filterHistory()">
                    </div>
                    <div class="history-filters">
                        <select id="historyFilter" onchange="filterHistory()">
                            <option value="all">すべて</option>
                            <option value="training">🏋️ トレーニング</option>
                            <option value="hiking">🥾 登山</option>
                            <option value="meal">🍽️ 食事</option>
                            <option value="alcohol">🍺 お酒</option>
                            <option value="steps">👣 歩数</option>
                            <option value="vitals">💓 バイタル</option>
                            <option value="weight">⚖️ 体重</option>
                            <option value="other">📝 その他</option>
                        </select>
                        <input type="date" id="historyDateFilter" onchange="filterHistory()">
                    </div>
                </div>

                <!-- 表示切替タブ -->
                <div class="history-view-tabs">
                    <button class="history-view-tab active" onclick="setHistoryView('list')" data-view="list">📋 リスト</button>
                    <button class="history-view-tab" onclick="setHistoryView('calendar')" data-view="calendar">📅 カレンダー</button>
                    <button class="history-view-tab" onclick="setHistoryView('daily')" data-view="daily">📊 日別サマリー</button>
                </div>

                <!-- リスト表示 -->
                <div class="history-view" id="historyListView">
                    <div class="history-list" id="historyList"></div>
                </div>

                <!-- カレンダー表示 -->
                <div class="history-view" id="historyCalendarView" style="display:none;">
                    <div class="history-calendar">
                        <div class="calendar-header">
                            <button class="btn btn-secondary" onclick="changeCalendarMonth(-1)">◀</button>
                            <span id="calendarMonthLabel">2024年1月</span>
                            <button class="btn btn-secondary" onclick="changeCalendarMonth(1)">▶</button>
                        </div>
                        <div class="calendar-weekdays">
                            <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>

                <!-- 日別サマリー表示 -->
                <div class="history-view" id="historyDailyView" style="display:none;">
                    <div class="daily-summary-list" id="dailySummaryList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 記録詳細モーダル -->
    <div class="modal-overlay" id="recordDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="recordDetailTitle">記録詳細</h3>
                <button class="modal-close" onclick="closeRecordDetail()">&times;</button>
            </div>
            <div class="modal-body" id="recordDetailBody">
                <!-- 詳細内容 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="editRecord()">✏️ 編集</button>
                <button class="btn btn-danger" onclick="deleteRecord()">🗑️ 削除</button>
            </div>
        </div>
    </div>

    <!-- 記録編集モーダル -->
    <div class="modal-overlay" id="recordEditModal">
        <div class="modal">
            <div class="modal-header">
                <h3>記録を編集</h3>
                <button class="modal-close" onclick="closeRecordEdit()">&times;</button>
            </div>
            <div class="modal-body" id="recordEditBody">
                <!-- 編集フォーム -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRecordEdit()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveRecordEdit()">💾 保存</button>
            </div>
        </div>
    </div>

    <!-- 動画再生モーダル -->
    <div class="modal-overlay" id="videoModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="videoModalTitle">動画再生</h3>
                <button class="modal-close" onclick="closeVideoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="video-player" id="videoPlayer"></div>
            </div>
        </div>
    </div>

    <!-- お気に入り追加モーダル -->
    <div class="modal-overlay" id="addFavoriteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="addFavoriteTitle">リンクを追加</h3>
                <button class="modal-close" onclick="closeAddFavoriteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="favoriteCategory">
                <div class="input-group">
                    <label>タイトル</label>
                    <input type="text" id="favoriteName" placeholder="例: 筋トレ動画">
                </div>
                <div class="input-group">
                    <label>URL</label>
                    <input type="text" id="favoriteUrl" placeholder="https://...">
                </div>
                <div class="input-group">
                    <label>アイコン（絵文字）</label>
                    <div class="emoji-picker" id="emojiPicker">
                        <span class="emoji-option" data-emoji="📺">📺</span>
                        <span class="emoji-option" data-emoji="🎬">🎬</span>
                        <span class="emoji-option" data-emoji="🎵">🎵</span>
                        <span class="emoji-option" data-emoji="🏋️">🏋️</span>
                        <span class="emoji-option" data-emoji="🧘">🧘</span>
                        <span class="emoji-option" data-emoji="🍳">🍳</span>
                        <span class="emoji-option" data-emoji="🥗">🥗</span>
                        <span class="emoji-option" data-emoji="🎸">🎸</span>
                        <span class="emoji-option" data-emoji="🎤">🎤</span>
                        <span class="emoji-option" data-emoji="💪">💪</span>
                        <span class="emoji-option" data-emoji="🔥">🔥</span>
                        <span class="emoji-option selected" data-emoji="⭐">⭐</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddFavoriteModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="addFavorite()">追加する</button>
            </div>
        </div>
    </div>

    <!-- 買い物リストモーダル -->
    <div class="modal-overlay" id="shoppingListModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>🛒 1週間の買い物リスト</h3>
                <button class="modal-close" onclick="closeShoppingListModal()">&times;</button>
            </div>
            <div class="modal-body" id="shoppingListBody">
                <!-- 買い物リスト -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="copyShoppingList()">📋 コピー</button>
                <button class="btn btn-primary" onclick="closeShoppingListModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 保存メニュー詳細モーダル -->
    <div class="modal-overlay" id="savedMenuModal">
        <div class="modal" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="savedMenuTitle">保存したメニュー</h3>
                <button class="modal-close" onclick="closeSavedMenuModal()">&times;</button>
            </div>
            <div class="modal-body" id="savedMenuBody">
                <!-- メニュー詳細 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteSavedMenu()">🗑️ 削除</button>
                <button class="btn btn-secondary" onclick="generateShoppingListFromSaved()">🛒 買い物リスト</button>
                <button class="btn btn-primary" onclick="closeSavedMenuModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- レベルアップ通知 -->
    <div class="level-up-notification" id="levelUpNotification">
        <div class="level-up-icon">🎉</div>
        <div class="level-up-text">LEVEL UP!</div>
        <p style="margin-top: 10px; color: var(--text-secondary);">レベル <span id="newLevel">2</span> になりました！</p>
    </div>

    <!-- リマインダー通知ポップアップ -->
    <div class="notification-popup" id="reminderPopup">
        <div class="notification-icon" id="reminderPopupIcon">⏰</div>
        <div class="notification-time" id="reminderPopupTime">08:00</div>
        <div class="notification-title" id="reminderPopupTitle">リマインダー</div>
        <div class="notification-message" id="reminderPopupMessage">記録の時間です！</div>
        <div class="notification-buttons">
            <button class="btn btn-secondary" onclick="snoozeReminder()">5分後に再通知</button>
            <button class="btn btn-primary" onclick="dismissReminder()">OK</button>
        </div>
    </div>

    <!-- 音声認識フィードバック -->
    <div class="voice-feedback" id="voiceFeedback">
        <div class="voice-waves">
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
        </div>
        <span id="voiceText">聞き取り中...</span>
    </div>

    <!-- フローティングボタン（カレンダー） -->
    <a href="https://calendar.google.com/" target="_blank" class="floating-calendar-btn" title="Googleカレンダーを開く">
        📅
    </a>

    <script>
        // Supabase設定
        const SUPABASE_URL = 'https://otfxdxkbideajmfetjgn.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_YIHmkEv5FzB4woyOE0gvtw_jIuihrEz';
        
        // Google Fit API設定
        const GOOGLE_FIT_CLIENT_ID = '878621914860-v3ji8runi7c1hq4puvabtl29271dej1i.apps.googleusercontent.com';
        const GOOGLE_FIT_SCOPES = 'https://www.googleapis.com/auth/fitness.activity.read';
        
        let googleFitAccessToken = null;
        let googleFitTokenClient = null;
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ユーザーID（ブラウザごとに固有）
        let userId = localStorage.getItem('healthTracker_userId');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('healthTracker_userId', userId);
        }

        // ローカルデータ（キャッシュ）
        let userData = {
            level: 1,
            xp: 0,
            streak: 0,
            lastActivityDate: null,
            todaySteps: 0,
            currentWeight: null,
            badges: []
        };

        let historyData = [];
        let videosData = [];
        let dailyChallenges = [];
        let challengeCompletedToday = {};

        // 実績定義
        const allBadges = [
            { id: 'first_step', name: '初めの一歩', desc: '最初の記録', icon: '🌱' },
            { id: 'week_streak', name: '一週間継続', desc: '7日連続記録', icon: '🔥' },
            { id: 'month_streak', name: '一ヶ月継続', desc: '30日連続記録', icon: '💎' },
            { id: 'walker', name: 'ウォーカー', desc: '10,000歩達成', icon: '🚶' },
            { id: 'level5', name: 'レベル5達成', desc: 'レベル5になる', icon: '⭐' },
            { id: 'level10', name: 'レベル10達成', desc: 'レベル10になる', icon: '🌟' },
            { id: 'trainer', name: 'トレーナー', desc: 'トレーニング10回', icon: '💪' },
            { id: 'chef', name: 'シェフ', desc: '食事記録20回', icon: '👨‍🍳' }
        ];

        // デイリーチャレンジテンプレート
        const challengeTemplates = [
            { text: '8,000歩以上歩く', xp: 20, type: 'steps_8000', auto: true },
            { text: 'トレーニングを1回行う', xp: 20, type: 'training' },
            { text: '3食の食事を記録する', xp: 25, type: 'meal' },
            { text: '体重を記録する', xp: 10, type: 'weight' },
            { text: '休肝日にする（お酒を飲まない）', xp: 15, type: 'no_alcohol', auto: true },
            { text: '軽い運動動画を1本見る', xp: 15, type: 'exercise' }
        ];

        // 同期ステータス更新
        function setSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            const text = document.getElementById('syncText');
            el.className = 'sync-status ' + status;
            
            switch(status) {
                case 'synced':
                    text.textContent = '同期済み';
                    break;
                case 'syncing':
                    text.textContent = '同期中...';
                    break;
                case 'error':
                    text.textContent = '同期エラー';
                    break;
            }
        }

        // ========================================
        // Google Fit 連携機能
        // ========================================
        
        // Google Identity Services初期化
        function initGoogleFit() {
            if (typeof google === 'undefined' || !google.accounts) {
                console.log('Google Identity Services not loaded yet');
                setTimeout(initGoogleFit, 500);
                return;
            }
            
            googleFitTokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_FIT_CLIENT_ID,
                scope: GOOGLE_FIT_SCOPES,
                callback: handleGoogleFitCallback,
            });
            
            // 保存されたトークンがあれば復元
            const savedToken = localStorage.getItem('lifecompass_googlefit_token');
            if (savedToken) {
                googleFitAccessToken = savedToken;
                updateGoogleFitButton(true);
            }
            
            console.log('Google Fit initialized');
        }
        
        // Google Fitボタンクリック処理
        function handleGoogleFit() {
            const btn = document.getElementById('googleFitBtn');
            const status = document.getElementById('googleFitStatus');
            
            if (googleFitAccessToken) {
                // 既に認証済み → 歩数を取得
                btn.classList.add('loading');
                document.getElementById('googleFitBtnText').textContent = '同期中...';
                fetchGoogleFitSteps();
            } else {
                // 未認証 → 認証開始
                if (googleFitTokenClient) {
                    status.textContent = 'Googleアカウントで認証中...';
                    status.className = 'google-fit-status';
                    googleFitTokenClient.requestAccessToken();
                } else {
                    status.textContent = 'Google APIの読み込み中です...';
                    status.className = 'google-fit-status error';
                    initGoogleFit();
                }
            }
        }
        
        // 認証コールバック
        function handleGoogleFitCallback(response) {
            const status = document.getElementById('googleFitStatus');
            
            if (response.error) {
                console.error('Google Fit auth error:', response);
                status.textContent = '認証エラー: ' + (response.error_description || response.error);
                status.className = 'google-fit-status error';
                return;
            }
            
            googleFitAccessToken = response.access_token;
            localStorage.setItem('lifecompass_googlefit_token', googleFitAccessToken);
            
            updateGoogleFitButton(true);
            status.textContent = '認証成功！歩数を取得中...';
            status.className = 'google-fit-status success';
            
            fetchGoogleFitSteps();
        }
        
        // Google Fit API から歩数を取得
        async function fetchGoogleFitSteps() {
            const btn = document.getElementById('googleFitBtn');
            const status = document.getElementById('googleFitStatus');
            
            btn.classList.add('loading');
            
            try {
                // 今日の0時から現在までの歩数を取得
                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const startTimeMillis = startOfDay.getTime();
                const endTimeMillis = now.getTime();
                
                const response = await fetch('https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + googleFitAccessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        aggregateBy: [{
                            dataTypeName: 'com.google.step_count.delta',
                            dataSourceId: 'derived:com.google.step_count.delta:com.google.android.gms:estimated_steps'
                        }],
                        bucketByTime: { durationMillis: 86400000 }, // 1日
                        startTimeMillis: startTimeMillis,
                        endTimeMillis: endTimeMillis
                    })
                });
                
                if (response.status === 401) {
                    // トークン期限切れ
                    googleFitAccessToken = null;
                    localStorage.removeItem('lifecompass_googlefit_token');
                    updateGoogleFitButton(false);
                    status.textContent = '認証が切れました。再度認証してください。';
                    status.className = 'google-fit-status error';
                    btn.classList.remove('loading');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('API Error: ' + response.status);
                }
                
                const data = await response.json();
                
                let totalSteps = 0;
                if (data.bucket && data.bucket.length > 0) {
                    data.bucket.forEach(bucket => {
                        if (bucket.dataset && bucket.dataset.length > 0) {
                            bucket.dataset.forEach(dataset => {
                                if (dataset.point && dataset.point.length > 0) {
                                    dataset.point.forEach(point => {
                                        if (point.value && point.value.length > 0) {
                                            totalSteps += point.value[0].intVal || 0;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                
                // 歩数を入力欄にセット
                document.getElementById('stepsInput').value = totalSteps;
                
                status.innerHTML = `✅ ${totalSteps.toLocaleString()} 歩を取得しました<br><small>「記録する」ボタンで保存してください</small>`;
                status.className = 'google-fit-status success';
                
                document.getElementById('googleFitBtnText').textContent = '再同期';
                
            } catch (error) {
                console.error('Google Fit fetch error:', error);
                status.textContent = '取得エラー: ' + error.message;
                status.className = 'google-fit-status error';
                document.getElementById('googleFitBtnText').textContent = '再試行';
            }
            
            btn.classList.remove('loading');
        }
        
        // ボタン表示を更新
        function updateGoogleFitButton(connected) {
            const btn = document.getElementById('googleFitBtn');
            const btnText = document.getElementById('googleFitBtnText');
            
            if (connected) {
                btn.classList.add('connected');
                btnText.textContent = '歩数を同期';
            } else {
                btn.classList.remove('connected');
                btnText.textContent = 'Google Fitから同期';
            }
        }
        
        // Google Fit接続解除
        function disconnectGoogleFit() {
            googleFitAccessToken = null;
            localStorage.removeItem('lifecompass_googlefit_token');
            updateGoogleFitButton(false);
            
            const status = document.getElementById('googleFitStatus');
            status.textContent = '接続を解除しました';
            status.className = 'google-fit-status';
        }

        // 初期化
        async function init() {
            document.getElementById('userIdDisplay').textContent = userId.substring(0, 12) + '...';
            const settingsUserIdEl = document.getElementById('settingsUserId');
            if (settingsUserIdEl) settingsUserIdEl.textContent = userId;
            
            await loadFromCloud();
            
            renderTabs();
            renderExerciseButtons();
            renderMealTypeButtons();
            renderAlcoholButtons();
            renderVideos();
            renderBadges();
            renderHistory();
            renderCharts();
            renderAlcoholChart();
            await loadDailyChallenges();
            updateUI();
            setupVoiceRecognition();
            renderHikingHistory();
            loadFavorites();
            setupEmojiPicker();
            renderVitalChart();
            loadDietMenuHistory();
            initGoogleFit();

            document.getElementById('loadingScreen').classList.add('hidden');
            
            console.log('ライフコンパス v5.3 (Google Fit連携) 初期化完了');
        }

        // ローカルデータをリセット
        function resetLocalData() {
            if (!confirm('ローカルデータ（お気に入り、リマインダーなど）をリセットしますか？\n\n※ Supabaseに保存された記録データは削除されません。')) {
                return;
            }
            
            // localStorageから関連データを削除
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('lifecompass_')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            alert('ローカルデータをリセットしました。ページを再読み込みします。');
            location.reload();
        }

        // クラウドからデータ読み込み
        async function loadFromCloud() {
            setSyncStatus('syncing');
            
            try {
                // ユーザープロフィール取得
                const { data: profile, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', userId)
                    .single();

                if (profile) {
                    userData = {
                        level: profile.level,
                        xp: profile.xp,
                        streak: profile.streak,
                        lastActivityDate: profile.last_activity_date,
                        todaySteps: profile.today_steps,
                        currentWeight: profile.current_weight,
                        badges: profile.badges || []
                    };
                } else if (profileError && profileError.code === 'PGRST116') {
                    // プロフィールがない場合は作成
                    await supabase.from('user_profiles').insert({
                        user_id: userId,
                        level: 1,
                        xp: 0,
                        streak: 0,
                        today_steps: 0,
                        badges: []
                    });
                }

                // 履歴取得
                const { data: records } = await supabase
                    .from('health_records')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (records) {
                    historyData = records.map(r => ({
                        type: r.record_type,
                        ...r.data,
                        date: r.created_at,
                        xp: r.xp_earned,
                        id: r.id
                    }));
                }

                // 動画取得
                const { data: videos } = await supabase
                    .from('exercise_videos')
                    .select('*')
                    .eq('user_id', userId);

                if (videos) {
                    videosData = videos;
                } else {
                    videosData = [];
                }

                setSyncStatus('synced');
            } catch (error) {
                console.error('Load error:', error);
                setSyncStatus('error');
            }
        }

        // プロフィール保存
        async function saveProfile() {
            setSyncStatus('syncing');
            
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .upsert({
                        user_id: userId,
                        level: userData.level,
                        xp: userData.xp,
                        streak: userData.streak,
                        last_activity_date: userData.lastActivityDate,
                        today_steps: userData.todaySteps,
                        current_weight: userData.currentWeight,
                        badges: userData.badges,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Save profile error:', error);
                setSyncStatus('error');
            }
        }

        // 記録保存
        async function saveRecord(type, data, xp) {
            setSyncStatus('syncing');
            
            try {
                const { data: record, error } = await supabase
                    .from('health_records')
                    .insert({
                        user_id: userId,
                        record_type: type,
                        data: data,
                        xp_earned: xp
                    })
                    .select()
                    .single();

                if (error) throw error;

                historyData.unshift({
                    type,
                    ...data,
                    date: record.created_at,
                    xp,
                    id: record.id
                });

                setSyncStatus('synced');
                return true;
            } catch (error) {
                console.error('Save record error:', error);
                setSyncStatus('error');
                return false;
            }
        }

        // UI更新
        function updateUI() {
            document.getElementById('currentLevel').textContent = userData.level;
            document.getElementById('streakDays').textContent = userData.streak;
            document.getElementById('todaySteps').textContent = userData.todaySteps.toLocaleString();
            document.getElementById('currentWeight').textContent = userData.currentWeight || '--';
            document.getElementById('badgeCount').textContent = userData.badges.length;
            document.getElementById('currentXP').textContent = userData.xp;
            
            const nextLevel = userData.level * 100;
            document.getElementById('nextLevelXP').textContent = nextLevel;
            
            const xpPercent = (userData.xp / nextLevel) * 100;
            document.getElementById('xpFill').style.width = `${Math.min(xpPercent, 100)}%`;
        }

        // XP追加
        async function addXP(amount) {
            userData.xp += amount;
            const nextLevel = userData.level * 100;
            
            if (userData.xp >= nextLevel) {
                userData.xp -= nextLevel;
                userData.level++;
                showLevelUp();
            }

            updateStreak();
            await saveProfile();
            updateUI();
            checkBadges();
        }

        function showLevelUp() {
            const notification = document.getElementById('levelUpNotification');
            document.getElementById('newLevel').textContent = userData.level;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ストリーク
        function updateStreak() {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            if (userData.lastActivityDate !== today) {
                if (userData.lastActivityDate === yesterday) {
                    userData.streak++;
                } else {
                    userData.streak = 1;
                }
                userData.lastActivityDate = today;
            }
        }

        // タブ切り替え
        function renderTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
        }

        // トレーニング種類ボタン
        function renderExerciseButtons() {
            document.querySelectorAll('.exercise-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.exercise-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    // 筋トレ選択時にメニューを表示
                    const strengthMenu = document.getElementById('strengthMenu');
                    if (btn.dataset.exercise === '筋トレ') {
                        strengthMenu.style.display = 'block';
                    } else {
                        strengthMenu.style.display = 'none';
                    }
                });
            });
        }

        // お酒種類ボタン
        function renderAlcoholButtons() {
            document.querySelectorAll('.alcohol-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.alcohol-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    // 度数とmlを自動入力
                    const percent = btn.dataset.percent;
                    const ml = btn.dataset.ml;
                    document.getElementById('alcoholPercent').value = percent;
                    document.getElementById('alcoholMl').value = ml;
                    updatePureAlcohol();
                });
            });
            
            // 度数・ml入力時に純アルコール量を計算
            document.getElementById('alcoholPercent')?.addEventListener('input', updatePureAlcohol);
            document.getElementById('alcoholMl')?.addEventListener('input', updatePureAlcohol);
        }

        // 純アルコール量を計算（g）
        function updatePureAlcohol() {
            const percent = parseFloat(document.getElementById('alcoholPercent').value) || 0;
            const ml = parseFloat(document.getElementById('alcoholMl').value) || 0;
            // 純アルコール量 = 量(ml) × 度数(%) × 0.01 × 0.8(アルコール比重)
            const pureAlcohol = (ml * percent * 0.01 * 0.8).toFixed(1);
            document.getElementById('pureAlcohol').textContent = pureAlcohol + 'g';
        }

        // 食事タイプボタン
        function renderMealTypeButtons() {
            document.querySelectorAll('.meal-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.meal-type-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });
        }

        // 記録保存関数
        async function saveTraining() {
            const selectedExercise = document.querySelector('.exercise-btn.selected');
            const note = document.getElementById('trainingNote').value;
            const duration = document.getElementById('trainingDuration').value;
            const intensity = document.getElementById('trainingIntensity').value;

            if (!selectedExercise && !note) {
                alert('トレーニング内容を選択または入力してください');
                return;
            }

            // 筋トレメニューの取得
            let strengthMenus = [];
            let sets = 0;
            let reps = 0;
            if (selectedExercise && selectedExercise.dataset.exercise === '筋トレ') {
                document.querySelectorAll('.strength-item input:checked').forEach(cb => {
                    strengthMenus.push(cb.value);
                });
                sets = parseInt(document.getElementById('trainingSets').value) || 0;
                reps = parseInt(document.getElementById('trainingReps').value) || 0;
            }

            const data = {
                exercise: selectedExercise ? selectedExercise.dataset.exercise : 'その他',
                note,
                duration: parseInt(duration) || 0,
                intensity,
                strengthMenus: strengthMenus,
                sets: sets,
                reps: reps
            };

            const success = await saveRecord('training', data, 20);
            
            if (success) {
                await addXP(20);
                
                document.querySelectorAll('.exercise-btn').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll('.strength-item input').forEach(cb => cb.checked = false);
                document.getElementById('trainingNote').value = '';
                document.getElementById('trainingDuration').value = '';
                document.getElementById('trainingSets').value = '';
                document.getElementById('trainingReps').value = '';
                document.getElementById('strengthMenu').style.display = 'none';
                
                renderHistory();
                checkChallengeCompletion('training');
                showToast('トレーニングを記録しました！ +20 XP');
            }
        }

        async function saveMeal() {
            const selectedMeal = document.querySelector('.meal-type-btn.selected');
            const content = document.getElementById('mealContent').value;
            const calories = document.getElementById('mealCalories').value;
            const satisfaction = document.getElementById('mealSatisfaction').value;

            if (!content) {
                alert('食事内容を入力してください');
                return;
            }

            const data = {
                mealType: selectedMeal.dataset.meal,
                content,
                calories: parseInt(calories) || 0,
                satisfaction: parseInt(satisfaction)
            };

            const success = await saveRecord('meal', data, 10);
            
            if (success) {
                await addXP(10);
                
                document.getElementById('mealContent').value = '';
                document.getElementById('mealCalories').value = '';
                
                renderHistory();
                checkChallengeCompletion('meal');
                showToast('食事を記録しました！ +10 XP');
            }
        }

        async function saveSteps() {
            const steps = parseInt(document.getElementById('stepsInput').value);

            if (!steps || steps < 0) {
                alert('歩数を入力してください');
                return;
            }

            const data = { steps };

            const success = await saveRecord('steps', data, 15);
            
            if (success) {
                userData.todaySteps = steps;
                await addXP(15);
                
                document.getElementById('stepsInput').value = '';
                
                renderHistory();
                renderCharts();
                checkChallengeCompletion('steps');
                renderChallenges(); // 自動チャレンジをチェック
                showToast('歩数を記録しました！ +15 XP');
            }
        }

        async function saveWeight() {
            const weight = parseFloat(document.getElementById('weightInput').value);

            if (!weight || weight < 0) {
                alert('体重を入力してください');
                return;
            }

            const data = { weight };

            const success = await saveRecord('weight', data, 10);
            
            if (success) {
                userData.currentWeight = weight;
                await addXP(10);
                
                document.getElementById('weightInput').value = '';
                
                renderHistory();
                renderCharts();
                checkChallengeCompletion('weight');
                showToast('体重を記録しました！ +10 XP');
            }
        }

        async function saveOther() {
            const category = document.getElementById('otherCategory').value;
            const content = document.getElementById('otherContent').value;

            if (!content) {
                alert('内容を入力してください');
                return;
            }

            const data = { category, content };

            const success = await saveRecord('other', data, 5);
            
            if (success) {
                await addXP(5);
                
                document.getElementById('otherContent').value = '';
                
                renderHistory();
                showToast('記録しました！ +5 XP');
            }
        }

        // お酒記録保存
        async function saveAlcohol() {
            const selectedDrink = document.querySelector('.alcohol-btn.selected');
            const percent = parseFloat(document.getElementById('alcoholPercent').value) || 0;
            const ml = parseFloat(document.getElementById('alcoholMl').value) || 0;
            const place = document.getElementById('alcoholPlace').value;
            const note = document.getElementById('alcoholNote').value;

            if (percent <= 0 || ml <= 0) {
                alert('アルコール度数と量を入力してください');
                return;
            }

            const drinkNames = {
                beer: 'ビール',
                wine: 'ワイン',
                sake: '日本酒',
                shochu: '焼酎',
                whiskey: 'ウイスキー',
                highball: 'ハイボール',
                chuhai: 'チューハイ',
                cocktail: 'カクテル'
            };

            // 純アルコール量を計算
            const pureAlcohol = (ml * percent * 0.01 * 0.8);

            const data = {
                drink: selectedDrink ? selectedDrink.dataset.drink : 'other',
                drinkName: selectedDrink ? drinkNames[selectedDrink.dataset.drink] : 'その他',
                percent: percent,
                ml: ml,
                pureAlcohol: pureAlcohol,
                place: place,
                note: note
            };

            const success = await saveRecord('alcohol', data, 5);
            
            if (success) {
                await addXP(5);
                
                document.querySelectorAll('.alcohol-btn').forEach(b => b.classList.remove('selected'));
                document.getElementById('alcoholPercent').value = '';
                document.getElementById('alcoholMl').value = '';
                document.getElementById('alcoholNote').value = '';
                document.getElementById('pureAlcohol').textContent = '0g';
                
                renderHistory();
                renderAlcoholChart();
                showToast('お酒を記録しました！ +5 XP');
            }
        }

        // お酒グラフ表示
        function renderAlcoholChart() {
            const container = document.getElementById('alcoholChart');
            const labels = document.getElementById('alcoholLabels');
            const weeklyTotal = document.getElementById('weeklyAlcoholTotal');
            const freeDays = document.getElementById('alcoholFreeDays');
            
            if (!container || !labels) return;
            
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const today = new Date().getDay();
            
            // 過去7日分のデータを取得
            const weekData = [];
            let totalAlcohol = 0;
            let daysWithoutDrink = 0;
            
            for (let i = 6; i >= 0; i--) {
                const targetDate = new Date(Date.now() - i * 86400000).toISOString().split('T')[0];
                const dayRecords = historyData.filter(h => 
                    h.type === 'alcohol' && h.date && h.date.startsWith(targetDate)
                );
                
                let dayTotal = 0;
                dayRecords.forEach(r => {
                    // 純アルコール量を使用（旧データとの互換性も考慮）
                    if (r.pureAlcohol) {
                        dayTotal += r.pureAlcohol;
                    } else if (r.percent && r.ml) {
                        dayTotal += r.ml * r.percent * 0.01 * 0.8;
                    } else if (r.amount) {
                        // 旧形式（杯数）の場合、1杯≒14gで概算
                        dayTotal += (r.amount || 1) * 14;
                    }
                });
                
                weekData.push(dayTotal);
                totalAlcohol += dayTotal;
                if (dayTotal === 0) daysWithoutDrink++;
            }

            const maxAmount = Math.max(...weekData, 40); // 40g = 適量の2倍を基準
            
            container.innerHTML = weekData.map((amount, i) => {
                const height = (amount / maxAmount) * 150;
                // 20g以上で警告色
                const barColor = amount > 20 ? 'linear-gradient(135deg, #ff6b35, #ff00aa)' : 'linear-gradient(135deg, #00d4ff, #00ff88)';
                return `<div class="chart-bar" style="height: ${Math.max(height, 5)}px; background: ${barColor};" data-value="${amount.toFixed(0)}g"></div>`;
            }).join('');

            labels.innerHTML = weekData.map((_, i) => {
                const dayIndex = (today - 6 + i + 7) % 7;
                return `<div class="chart-label">${days[dayIndex]}</div>`;
            }).join('');
            
            if (weeklyTotal) weeklyTotal.textContent = totalAlcohol.toFixed(0) + 'g';
            if (freeDays) freeDays.textContent = daysWithoutDrink + ' 日';
        }

        // YouTube動画管理
        async function addYoutubeVideo() {
            const url = document.getElementById('youtubeUrl').value;
            const description = document.getElementById('videoDescription').value;
            const videoId = extractYoutubeId(url);

            if (!videoId) {
                alert('有効なYouTube URLを入力してください');
                return;
            }

            if (!description) {
                alert('動画の説明を入力してください');
                return;
            }

            setSyncStatus('syncing');

            try {
                const { data, error } = await supabase
                    .from('exercise_videos')
                    .insert({
                        user_id: userId,
                        video_id: videoId,
                        title: description,
                        duration: '',
                        category: ''
                    })
                    .select()
                    .single();

                if (error) throw error;

                videosData.push(data);
                renderVideos();
                document.getElementById('youtubeUrl').value = '';
                document.getElementById('videoDescription').value = '';
                setSyncStatus('synced');
                showToast('動画を追加しました！');
            } catch (error) {
                console.error('Add video error:', error);
                setSyncStatus('error');
            }
        }

        async function deleteVideo(id, event) {
            event.stopPropagation();
            
            if (!confirm('この動画を削除しますか？')) return;

            setSyncStatus('syncing');

            try {
                const { error } = await supabase
                    .from('exercise_videos')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                videosData = videosData.filter(v => v.id !== id);
                renderVideos();
                setSyncStatus('synced');
                showToast('動画を削除しました');
            } catch (error) {
                console.error('Delete video error:', error);
                setSyncStatus('error');
            }
        }

        function extractYoutubeId(url) {
            const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/);
            return match ? match[1] : null;
        }

        function renderVideos() {
            const container = document.getElementById('videoList');
            
            if (videosData.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:40px;">登録された動画はありません</div>';
                return;
            }
            
            container.innerHTML = videosData.map(video => `
                <div class="video-item" onclick="playVideo('${video.video_id}', '${(video.title || '').replace(/'/g, "\\'")}')">
                    <div class="video-thumb">
                        <img src="https://img.youtube.com/vi/${video.video_id}/mqdefault.jpg" alt="${video.title}" onerror="this.style.display='none'">
                    </div>
                    <div class="video-info">
                        <div class="video-title">${video.title || '動画'}</div>
                    </div>
                    ${video.id ? `<button class="video-delete" onclick="deleteVideo('${video.id}', event)">×</button>` : ''}
                </div>
            `).join('');
        }

        function playVideo(videoId, title) {
            document.getElementById('videoModalTitle').textContent = title || '動画再生';
            document.getElementById('videoPlayer').innerHTML = `
                <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen></iframe>
            `;
            document.getElementById('videoModal').classList.add('active');
            checkChallengeCompletion('exercise');
        }

        function closeVideoModal() {
            document.getElementById('videoModal').classList.remove('active');
            document.getElementById('videoPlayer').innerHTML = '';
        }

        // バッジ管理
        function renderBadges() {
            const container = document.getElementById('badgesGrid');
            container.innerHTML = allBadges.map(badge => {
                const unlocked = userData.badges.includes(badge.id);
                return `
                    <div class="badge ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-desc">${badge.desc}</div>
                    </div>
                `;
            }).join('');
        }

        async function checkBadges() {
            let newBadges = false;

            const checks = {
                'first_step': historyData.length >= 1,
                'week_streak': userData.streak >= 7,
                'month_streak': userData.streak >= 30,
                'walker': userData.todaySteps >= 10000,
                'level5': userData.level >= 5,
                'level10': userData.level >= 10,
                'trainer': historyData.filter(h => h.type === 'training').length >= 10,
                'chef': historyData.filter(h => h.type === 'meal').length >= 20
            };

            for (const [id, condition] of Object.entries(checks)) {
                if (!userData.badges.includes(id) && condition) {
                    userData.badges.push(id);
                    const badge = allBadges.find(b => b.id === id);
                    showToast(`🏆 新しい実績解除: ${badge.name}！`);
                    newBadges = true;
                }
            }

            if (newBadges) {
                await saveProfile();
                renderBadges();
                updateUI();
            }
        }

        // 履歴表示
        // 履歴表示の状態管理
        let currentHistoryView = 'list';
        let currentCalendarMonth = new Date();
        let selectedRecordId = null;

        function renderHistory() {
            const container = document.getElementById('historyList');
            const filter = document.getElementById('historyFilter')?.value || 'all';
            const searchText = document.getElementById('historySearch')?.value?.toLowerCase() || '';
            const dateFilter = document.getElementById('historyDateFilter')?.value || '';
            
            let filtered = historyData;
            
            // タイプフィルター
            if (filter !== 'all') {
                filtered = filtered.filter(h => h.type === filter);
            }
            
            // 日付フィルター
            if (dateFilter) {
                filtered = filtered.filter(h => h.date && h.date.startsWith(dateFilter));
            }
            
            // テキスト検索
            if (searchText) {
                filtered = filtered.filter(h => {
                    const content = getRecordSearchText(h).toLowerCase();
                    return content.includes(searchText);
                });
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:40px;">記録がありません</div>';
                return;
            }

            container.innerHTML = filtered.slice(0, 100).map(record => {
                const date = new Date(record.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                const { icon, title, subtitle } = getRecordDisplay(record);

                return `
                    <div class="history-item" onclick="showRecordDetail('${record.id}')">
                        <div class="history-item-icon">${icon}</div>
                        <div class="history-item-main">
                            <div class="history-item-title">${title}</div>
                            <div class="history-item-subtitle">${subtitle}</div>
                        </div>
                        <div class="history-item-meta">
                            <div class="history-item-time">${dateStr} ${timeStr}</div>
                            <div class="history-item-xp">+${record.xp} XP</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 記録の表示情報を取得
        function getRecordDisplay(record) {
            let icon = '📝';
            let title = '';
            let subtitle = '';
            
            switch(record.type) {
                case 'training':
                    icon = '🏋️';
                    title = record.exercise || 'トレーニング';
                    if (record.strengthMenus && record.strengthMenus.length > 0) {
                        subtitle = record.strengthMenus.join(', ');
                    }
                    if (record.duration) {
                        subtitle += (subtitle ? ' / ' : '') + `${record.duration}分`;
                    }
                    break;
                case 'meal':
                    icon = record.mealType === '朝食' ? '🌅' : record.mealType === '昼食' ? '☀️' : record.mealType === '夕食' ? '🌙' : '🍽️';
                    title = record.mealType || '食事';
                    subtitle = record.content || '';
                    break;
                case 'alcohol':
                    icon = '🍺';
                    title = record.drinkName || record.drink || 'お酒';
                    const pureAlc = record.pureAlcohol ? record.pureAlcohol.toFixed(1) : 
                                    (record.ml && record.percent) ? (record.ml * record.percent * 0.01 * 0.8).toFixed(1) : '?';
                    subtitle = `${record.ml || ''}ml (${pureAlc}g)`;
                    if (record.place) subtitle += ` @ ${record.place}`;
                    break;
                case 'hiking':
                    icon = '🥾';
                    title = record.name || '登山';
                    subtitle = `${(record.distance || 0).toFixed(1)}km`;
                    if (record.elevationGain) subtitle += ` ↑${record.elevationGain}m`;
                    break;
                case 'steps':
                    icon = '👣';
                    title = '歩数';
                    subtitle = `${(record.steps || 0).toLocaleString()} 歩`;
                    break;
                case 'weight':
                    icon = '⚖️';
                    title = '体重';
                    subtitle = `${record.weight} kg`;
                    break;
                case 'vitals':
                    icon = '💓';
                    title = 'バイタル';
                    let vitalParts = [];
                    if (record.weight) vitalParts.push(`${record.weight}kg`);
                    if (record.bpHigh && record.bpLow) vitalParts.push(`BP ${record.bpHigh}/${record.bpLow}`);
                    if (record.heartRate) vitalParts.push(`${record.heartRate}bpm`);
                    if (record.temp) vitalParts.push(`${record.temp}℃`);
                    subtitle = vitalParts.join(' / ') || 'データあり';
                    break;
                case 'other':
                    icon = '📝';
                    title = record.category || 'その他';
                    subtitle = record.content || '';
                    break;
            }
            
            return { icon, title, subtitle: subtitle.substring(0, 50) };
        }

        // 検索用テキストを取得
        function getRecordSearchText(record) {
            const parts = [record.type];
            switch(record.type) {
                case 'training':
                    parts.push(record.exercise, record.note, ...(record.strengthMenus || []));
                    break;
                case 'meal':
                    parts.push(record.mealType, record.content);
                    break;
                case 'alcohol':
                    parts.push(record.drinkName, record.drink, record.place, record.note);
                    break;
                case 'hiking':
                    parts.push(record.name);
                    break;
                case 'other':
                    parts.push(record.category, record.content);
                    break;
            }
            return parts.filter(Boolean).join(' ');
        }

        // 表示切替
        function setHistoryView(view) {
            currentHistoryView = view;
            
            document.querySelectorAll('.history-view-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            
            document.getElementById('historyListView').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('historyCalendarView').style.display = view === 'calendar' ? 'block' : 'none';
            document.getElementById('historyDailyView').style.display = view === 'daily' ? 'block' : 'none';
            
            if (view === 'calendar') {
                renderCalendarView();
            } else if (view === 'daily') {
                renderDailySummaryView();
            }
        }

        // カレンダー表示
        function renderCalendarView() {
            const grid = document.getElementById('calendarGrid');
            const label = document.getElementById('calendarMonthLabel');
            
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            
            label.textContent = `${year}年${month + 1}月`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // 日付ごとの記録数を集計
            const recordsByDate = {};
            historyData.forEach(record => {
                if (record.date) {
                    const dateStr = record.date.split('T')[0];
                    recordsByDate[dateStr] = (recordsByDate[dateStr] || 0) + 1;
                }
            });
            
            let html = '';
            
            // 前月の日付
            const prevMonth = new Date(year, month, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="calendar-day other-month">${day}</div>`;
            }
            
            // 当月の日付
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasRecords = recordsByDate[dateStr] > 0;
                const isToday = dateStr === todayStr;
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasRecords ? 'has-records' : ''}" 
                             onclick="showDayRecords('${dateStr}')">${day}</div>`;
            }
            
            // 次月の日付
            const remainingDays = 42 - (startDay + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="calendar-day other-month">${day}</div>`;
            }
            
            grid.innerHTML = html;
        }

        function changeCalendarMonth(delta) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
            renderCalendarView();
        }

        function showDayRecords(dateStr) {
            document.getElementById('historyDateFilter').value = dateStr;
            setHistoryView('list');
            filterHistory();
        }

        // 日別サマリー表示
        function renderDailySummaryView() {
            const container = document.getElementById('dailySummaryList');
            
            // 日付ごとにグループ化
            const byDate = {};
            historyData.forEach(record => {
                if (record.date) {
                    const dateStr = record.date.split('T')[0];
                    if (!byDate[dateStr]) {
                        byDate[dateStr] = [];
                    }
                    byDate[dateStr].push(record);
                }
            });
            
            const dates = Object.keys(byDate).sort().reverse().slice(0, 30);
            
            if (dates.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:40px;">記録がありません</div>';
                return;
            }
            
            container.innerHTML = dates.map(dateStr => {
                const records = byDate[dateStr];
                const date = new Date(dateStr);
                const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
                const formattedDate = `${date.getMonth() + 1}/${date.getDate()} (${dayNames[date.getDay()]})`;
                
                // 統計を計算
                const totalXP = records.reduce((sum, r) => sum + (r.xp || 0), 0);
                const steps = records.find(r => r.type === 'steps')?.steps || 0;
                const alcohol = records.filter(r => r.type === 'alcohol')
                    .reduce((sum, r) => sum + (r.pureAlcohol || 0), 0);
                
                return `
                    <div class="daily-summary-item">
                        <div class="daily-summary-header">
                            <div class="daily-summary-date">${formattedDate}</div>
                            <div class="daily-summary-stats">
                                <div class="daily-summary-stat">
                                    <div class="daily-summary-stat-value">${records.length}</div>
                                    <div class="daily-summary-stat-label">記録</div>
                                </div>
                                <div class="daily-summary-stat">
                                    <div class="daily-summary-stat-value">${totalXP}</div>
                                    <div class="daily-summary-stat-label">XP</div>
                                </div>
                                ${steps > 0 ? `
                                <div class="daily-summary-stat">
                                    <div class="daily-summary-stat-value">${(steps/1000).toFixed(1)}k</div>
                                    <div class="daily-summary-stat-label">歩</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="daily-summary-records">
                            ${records.map(r => {
                                const { icon, title, subtitle } = getRecordDisplay(r);
                                return `
                                    <div class="daily-summary-record" onclick="showRecordDetail('${r.id}')">
                                        ${icon} <span>${title}</span>
                                        <span style="color:var(--text-secondary);margin-left:auto;">${subtitle}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 記録詳細表示
        function showRecordDetail(recordId) {
            const record = historyData.find(r => r.id === recordId);
            if (!record) return;
            
            selectedRecordId = recordId;
            
            const date = new Date(record.date);
            const formattedDate = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            const { icon, title } = getRecordDisplay(record);
            document.getElementById('recordDetailTitle').textContent = `${icon} ${title}`;
            
            let detailHtml = '<div class="record-detail-grid">';
            detailHtml += `<div class="record-detail-item"><span class="record-detail-label">日時</span><span class="record-detail-value">${formattedDate}</span></div>`;
            detailHtml += `<div class="record-detail-item"><span class="record-detail-label">種類</span><span class="record-detail-value">${record.type}</span></div>`;
            
            switch(record.type) {
                case 'training':
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">運動</span><span class="record-detail-value">${record.exercise}</span></div>`;
                    if (record.duration) detailHtml += `<div class="record-detail-item"><span class="record-detail-label">時間</span><span class="record-detail-value">${record.duration}分</span></div>`;
                    if (record.intensity) detailHtml += `<div class="record-detail-item"><span class="record-detail-label">強度</span><span class="record-detail-value">${record.intensity}</span></div>`;
                    if (record.strengthMenus?.length) detailHtml += `<div class="record-detail-item"><span class="record-detail-label">メニュー</span><span class="record-detail-value">${record.strengthMenus.join(', ')}</span></div>`;
                    if (record.sets) detailHtml += `<div class="record-detail-item"><span class="record-detail-label">セット数</span><span class="record-detail-value">${record.sets}セット</span></div>`;
                    if (record.reps) detailHtml += `<div class="record-detail-item"><span class="record-detail-label">回数</span><span class="record-detail-value">${record.reps}回</span></div>`;
                    if (record.note) detailHtml += `<div class="record-detail-item"><span class="record-detail-label">メモ</span><span class="record-detail-value">${record.note}</span></div>`;
                    break;
                case 'meal':
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">食事タイプ</span><span class="record-detail-value">${record.mealType}</span></div>`;
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">内容</span><span class="record-detail-value">${record.content}</span></div>`;
                    break;
                case 'alcohol':
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">お酒</span><span class="record-detail-value">${record.drinkName || record.drink}</span></div>`;
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">度数</span><span class="record-detail-value">${record.percent}%</span></div>`;
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">量</span><span class="record-detail-value">${record.ml}ml</span></div>`;
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">純アルコール</span><span class="record-detail-value">${(record.pureAlcohol || 0).toFixed(1)}g</span></div>`;
                    if (record.place) detailHtml += `<div class="record-detail-item"><span class="record-detail-label">場所</span><span class="record-detail-value">${record.place}</span></div>`;
                    if (record.note) detailHtml += `<div class="record-detail-item"><span class="record-detail-label">メモ</span><span class="record-detail-value">${record.note}</span></div>`;
                    break;
                case 'hiking':
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">山名</span><span class="record-detail-value">${record.name}</span></div>`;
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">距離</span><span class="record-detail-value">${(record.distance || 0).toFixed(2)}km</span></div>`;
                    if (record.elevationGain) detailHtml += `<div class="record-detail-item"><span class="record-detail-label">獲得標高</span><span class="record-detail-value">${record.elevationGain}m</span></div>`;
                    break;
                case 'steps':
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">歩数</span><span class="record-detail-value">${(record.steps || 0).toLocaleString()} 歩</span></div>`;
                    break;
                case 'weight':
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">体重</span><span class="record-detail-value">${record.weight} kg</span></div>`;
                    break;
                case 'other':
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">カテゴリ</span><span class="record-detail-value">${record.category}</span></div>`;
                    detailHtml += `<div class="record-detail-item"><span class="record-detail-label">内容</span><span class="record-detail-value">${record.content}</span></div>`;
                    break;
            }
            
            detailHtml += `<div class="record-detail-item"><span class="record-detail-label">獲得XP</span><span class="record-detail-value" style="color:var(--accent-gold);">+${record.xp} XP</span></div>`;
            detailHtml += '</div>';
            
            document.getElementById('recordDetailBody').innerHTML = detailHtml;
            document.getElementById('recordDetailModal').classList.add('active');
        }

        function closeRecordDetail() {
            document.getElementById('recordDetailModal').classList.remove('active');
            selectedRecordId = null;
        }

        // 記録編集
        function editRecord() {
            const record = historyData.find(r => r.id === selectedRecordId);
            if (!record) return;
            
            closeRecordDetail();
            
            let formHtml = '';
            
            switch(record.type) {
                case 'training':
                    formHtml = `
                        <div class="edit-form-group">
                            <label>運動種類</label>
                            <input type="text" id="editExercise" value="${record.exercise || ''}">
                        </div>
                        <div class="edit-form-group">
                            <label>時間（分）</label>
                            <input type="number" id="editDuration" value="${record.duration || ''}">
                        </div>
                        <div class="edit-form-group">
                            <label>メモ</label>
                            <textarea id="editNote">${record.note || ''}</textarea>
                        </div>
                    `;
                    break;
                case 'meal':
                    formHtml = `
                        <div class="edit-form-group">
                            <label>食事タイプ</label>
                            <select id="editMealType">
                                <option value="朝食" ${record.mealType === '朝食' ? 'selected' : ''}>朝食</option>
                                <option value="昼食" ${record.mealType === '昼食' ? 'selected' : ''}>昼食</option>
                                <option value="夕食" ${record.mealType === '夕食' ? 'selected' : ''}>夕食</option>
                                <option value="間食" ${record.mealType === '間食' ? 'selected' : ''}>間食</option>
                            </select>
                        </div>
                        <div class="edit-form-group">
                            <label>内容</label>
                            <textarea id="editContent">${record.content || ''}</textarea>
                        </div>
                    `;
                    break;
                case 'alcohol':
                    formHtml = `
                        <div class="edit-form-group">
                            <label>お酒の種類</label>
                            <input type="text" id="editDrinkName" value="${record.drinkName || ''}">
                        </div>
                        <div class="edit-form-group">
                            <label>度数（%）</label>
                            <input type="number" id="editPercent" value="${record.percent || ''}" step="0.1">
                        </div>
                        <div class="edit-form-group">
                            <label>量（ml）</label>
                            <input type="number" id="editMl" value="${record.ml || ''}">
                        </div>
                        <div class="edit-form-group">
                            <label>場所</label>
                            <input type="text" id="editPlace" value="${record.place || ''}">
                        </div>
                    `;
                    break;
                case 'steps':
                    formHtml = `
                        <div class="edit-form-group">
                            <label>歩数</label>
                            <input type="number" id="editSteps" value="${record.steps || ''}">
                        </div>
                    `;
                    break;
                case 'weight':
                    formHtml = `
                        <div class="edit-form-group">
                            <label>体重（kg）</label>
                            <input type="number" id="editWeight" value="${record.weight || ''}" step="0.1">
                        </div>
                    `;
                    break;
                default:
                    formHtml = `
                        <div class="edit-form-group">
                            <label>内容</label>
                            <textarea id="editContent">${record.content || ''}</textarea>
                        </div>
                    `;
            }
            
            document.getElementById('recordEditBody').innerHTML = formHtml;
            document.getElementById('recordEditModal').classList.add('active');
        }

        function closeRecordEdit() {
            document.getElementById('recordEditModal').classList.remove('active');
        }

        async function saveRecordEdit() {
            const record = historyData.find(r => r.id === selectedRecordId);
            if (!record) return;
            
            let updatedData = { ...record };
            
            switch(record.type) {
                case 'training':
                    updatedData.exercise = document.getElementById('editExercise').value;
                    updatedData.duration = parseInt(document.getElementById('editDuration').value) || null;
                    updatedData.note = document.getElementById('editNote').value;
                    break;
                case 'meal':
                    updatedData.mealType = document.getElementById('editMealType').value;
                    updatedData.content = document.getElementById('editContent').value;
                    break;
                case 'alcohol':
                    updatedData.drinkName = document.getElementById('editDrinkName').value;
                    updatedData.percent = parseFloat(document.getElementById('editPercent').value);
                    updatedData.ml = parseFloat(document.getElementById('editMl').value);
                    updatedData.pureAlcohol = updatedData.ml * updatedData.percent * 0.01 * 0.8;
                    updatedData.place = document.getElementById('editPlace').value;
                    break;
                case 'steps':
                    updatedData.steps = parseInt(document.getElementById('editSteps').value);
                    break;
                case 'weight':
                    updatedData.weight = parseFloat(document.getElementById('editWeight').value);
                    break;
                default:
                    updatedData.content = document.getElementById('editContent').value;
            }
            
            setSyncStatus('syncing');
            
            try {
                const { error } = await supabase
                    .from('health_records')
                    .update({ data: updatedData })
                    .eq('id', selectedRecordId);
                
                if (error) throw error;
                
                // ローカルデータも更新
                const index = historyData.findIndex(r => r.id === selectedRecordId);
                if (index !== -1) {
                    historyData[index] = { ...historyData[index], ...updatedData };
                }
                
                closeRecordEdit();
                renderHistory();
                setSyncStatus('synced');
                showToast('記録を更新しました');
            } catch (error) {
                console.error('Update error:', error);
                setSyncStatus('error');
                alert('更新に失敗しました');
            }
        }

        // 記録削除
        async function deleteRecord() {
            if (!confirm('この記録を削除しますか？')) return;
            
            setSyncStatus('syncing');
            
            try {
                const { error } = await supabase
                    .from('health_records')
                    .delete()
                    .eq('id', selectedRecordId);
                
                if (error) throw error;
                
                // ローカルデータからも削除
                historyData = historyData.filter(r => r.id !== selectedRecordId);
                
                closeRecordDetail();
                renderHistory();
                renderCharts();
                setSyncStatus('synced');
                showToast('記録を削除しました');
            } catch (error) {
                console.error('Delete error:', error);
                setSyncStatus('error');
                alert('削除に失敗しました');
            }
        }

        function filterHistory() {
            if (currentHistoryView === 'list') {
                renderHistory();
            } else if (currentHistoryView === 'daily') {
                renderDailySummaryView();
            }
        }

        // グラフ表示
        function renderCharts() {
            renderStepsChart();
            renderWeightChart();
        }

        function renderStepsChart() {
            const container = document.getElementById('stepsChart');
            const labels = document.getElementById('stepsLabels');
            
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const today = new Date().getDay();
            
            const weekData = [];
            for (let i = 6; i >= 0; i--) {
                const targetDate = new Date(Date.now() - i * 86400000).toISOString().split('T')[0];
                const record = historyData.find(h => 
                    h.type === 'steps' && h.date && h.date.startsWith(targetDate)
                );
                weekData.push(record ? record.steps : 0);
            }

            const maxSteps = Math.max(...weekData, 10000);
            
            container.innerHTML = weekData.map((steps, i) => {
                const height = (steps / maxSteps) * 180;
                return `<div class="chart-bar" style="height: ${height}px" data-value="${steps.toLocaleString()}"></div>`;
            }).join('');

            labels.innerHTML = weekData.map((_, i) => {
                const dayIndex = (today - 6 + i + 7) % 7;
                return `<div class="chart-label">${days[dayIndex]}</div>`;
            }).join('');
        }

        function renderWeightChart() {
            const container = document.getElementById('weightChart');
            const labels = document.getElementById('weightLabels');
            
            const weightRecords = historyData
                .filter(h => h.type === 'weight')
                .slice(0, 7)
                .reverse();

            if (weightRecords.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:50px;">データがありません</div>';
                labels.innerHTML = '';
                return;
            }

            const weights = weightRecords.map(r => r.weight);
            const minWeight = Math.min(...weights) - 2;
            const maxWeight = Math.max(...weights) + 2;
            const range = maxWeight - minWeight || 1;

            container.innerHTML = weightRecords.map(record => {
                const height = ((record.weight - minWeight) / range) * 180;
                return `<div class="chart-bar" style="height: ${height}px; background: linear-gradient(135deg, #00ff88, #00d4ff);" data-value="${record.weight}kg"></div>`;
            }).join('');

            labels.innerHTML = weightRecords.map(record => {
                const date = new Date(record.date);
                return `<div class="chart-label">${date.getMonth() + 1}/${date.getDate()}</div>`;
            }).join('');
        }

        // デイリーチャレンジ
        async function loadDailyChallenges() {
            const today = new Date().toISOString().split('T')[0];
            const challengeVersion = 2; // チャレンジ更新時にこの数字を増やす

            try {
                const { data, error } = await supabase
                    .from('daily_challenges')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('challenge_date', today)
                    .single();

                // 古いバージョンのチャレンジか、チャレンジがない場合は新しく生成
                if (data && data.version === challengeVersion) {
                    dailyChallenges = data.challenges;
                    challengeCompletedToday = data.completed || {};
                } else {
                    // 新しいチャレンジを生成
                    dailyChallenges = [...challengeTemplates].sort(() => Math.random() - 0.5).slice(0, 4);
                    challengeCompletedToday = {};

                    if (data) {
                        // 既存データを更新
                        await supabase.from('daily_challenges')
                            .update({
                                challenges: dailyChallenges,
                                completed: {},
                                version: challengeVersion
                            })
                            .eq('user_id', userId)
                            .eq('challenge_date', today);
                    } else {
                        // 新規作成
                        await supabase.from('daily_challenges').insert({
                            user_id: userId,
                            challenge_date: today,
                            challenges: dailyChallenges,
                            completed: {},
                            version: challengeVersion
                        });
                    }
                }
            } catch (error) {
                console.error('Load challenges error:', error);
                dailyChallenges = challengeTemplates.slice(0, 4);
            }

            renderChallenges();
        }

        function renderChallenges() {
            // まず自動チェックを実行
            checkAutoChallenges();
            
            const container = document.getElementById('challengeList');
            container.innerHTML = dailyChallenges.map((challenge, index) => {
                const completed = challengeCompletedToday[index];
                const isAuto = challenge.auto;
                return `
                    <div class="challenge-item">
                        <div class="challenge-checkbox ${completed ? 'completed' : ''} ${isAuto ? 'auto' : ''}" 
                             onclick="${isAuto ? '' : `toggleChallenge(${index})`}"
                             title="${isAuto ? '自動でチェックされます' : 'クリックで完了'}">
                            ${completed ? '✓' : isAuto ? '⏳' : ''}
                        </div>
                        <span class="challenge-text ${completed ? 'completed' : ''}">${challenge.text}${isAuto ? ' 🔄' : ''}</span>
                        <span class="challenge-xp">+${challenge.xp} XP</span>
                    </div>
                `;
            }).join('');
        }

        // 自動チャレンジのチェック
        async function checkAutoChallenges() {
            const today = new Date().toISOString().split('T')[0];
            let updated = false;

            for (let i = 0; i < dailyChallenges.length; i++) {
                const challenge = dailyChallenges[i];
                if (!challenge.auto || challengeCompletedToday[i]) continue;

                let isCompleted = false;

                switch (challenge.type) {
                    case 'steps_8000':
                        // 今日の歩数が8000以上かチェック
                        const stepsRecord = historyData.find(r => 
                            r.type === 'steps' && r.date && r.date.startsWith(today)
                        );
                        if (stepsRecord && stepsRecord.steps >= 8000) {
                            isCompleted = true;
                        }
                        break;

                    case 'no_alcohol':
                        // 今日のお酒記録がないかチェック（23時以降にチェック、または明示的にチェック）
                        const alcoholRecords = historyData.filter(r => 
                            r.type === 'alcohol' && r.date && r.date.startsWith(today)
                        );
                        const currentHour = new Date().getHours();
                        // 21時以降でお酒記録がなければ達成
                        if (currentHour >= 21 && alcoholRecords.length === 0) {
                            isCompleted = true;
                        }
                        break;
                }

                if (isCompleted && !challengeCompletedToday[i]) {
                    challengeCompletedToday[i] = true;
                    await addXP(challenge.xp);
                    updated = true;
                    showToast(`🎉 チャレンジ達成: ${challenge.text}`);
                }
            }

            if (updated) {
                await supabase
                    .from('daily_challenges')
                    .update({ completed: challengeCompletedToday })
                    .eq('user_id', userId)
                    .eq('challenge_date', today);
            }
        }

        async function toggleChallenge(index) {
            if (challengeCompletedToday[index]) return;

            challengeCompletedToday[index] = true;
            await addXP(dailyChallenges[index].xp);

            const today = new Date().toISOString().split('T')[0];
            await supabase
                .from('daily_challenges')
                .update({ completed: challengeCompletedToday })
                .eq('user_id', userId)
                .eq('challenge_date', today);

            renderChallenges();
        }

        async function checkChallengeCompletion(type) {
            for (let i = 0; i < dailyChallenges.length; i++) {
                if (dailyChallenges[i].type === type && !challengeCompletedToday[i]) {
                    challengeCompletedToday[i] = true;
                    await addXP(dailyChallenges[i].xp);
                }
            }

            const today = new Date().toISOString().split('T')[0];
            await supabase
                .from('daily_challenges')
                .update({ completed: challengeCompletedToday })
                .eq('user_id', userId)
                .eq('challenge_date', today);

            renderChallenges();
        }

        // 音声認識
        function setupVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                document.querySelectorAll('.btn-voice').forEach(btn => {
                    btn.style.display = 'none';
                });
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = false;
            recognition.interimResults = true;

            let currentTarget = null;

            document.querySelectorAll('.btn-voice').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.classList.contains('recording')) {
                        recognition.stop();
                        return;
                    }

                    currentTarget = btn.id.replace('voice', '').toLowerCase();
                    btn.classList.add('recording');
                    document.getElementById('voiceFeedback').classList.add('active');
                    document.getElementById('voiceText').textContent = '聞き取り中...';
                    recognition.start();
                });
            });

            recognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                
                document.getElementById('voiceText').textContent = transcript;

                if (event.results[0].isFinal) {
                    applyVoiceInput(currentTarget, transcript);
                }
            };

            recognition.onend = () => {
                document.querySelectorAll('.btn-voice').forEach(b => b.classList.remove('recording'));
                setTimeout(() => {
                    document.getElementById('voiceFeedback').classList.remove('active');
                }, 1500);
            };

            recognition.onerror = (event) => {
                console.error('音声認識エラー:', event.error);
                document.getElementById('voiceText').textContent = 'エラーが発生しました';
            };
        }

        function applyVoiceInput(target, text) {
            switch(target) {
                case 'training':
                    document.getElementById('trainingNote').value = text;
                    const minutes = text.match(/(\d+)分/);
                    if (minutes) {
                        document.getElementById('trainingDuration').value = minutes[1];
                    }
                    break;
                case 'meal':
                    document.getElementById('mealContent').value = text;
                    break;
                case 'steps':
                    const steps = text.match(/(\d+)/);
                    if (steps) {
                        document.getElementById('stepsInput').value = steps[1];
                    }
                    break;
                case 'weight':
                    const weight = text.match(/(\d+\.?\d*)/);
                    if (weight) {
                        document.getElementById('weightInput').value = weight[1];
                    }
                    break;
                case 'other':
                    document.getElementById('otherContent').value = text;
                    break;
            }
        }

        // トースト通知
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-card);
                color: var(--text-primary);
                padding: 15px 30px;
                border-radius: 50px;
                border: 1px solid var(--accent-cyan);
                z-index: 1000;
                animation: fadeIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // ============================================
        // GPX関連の関数
        // ============================================
        let currentGpxData = null;

        function setupGpxUpload() {
            const uploadArea = document.getElementById('gpxUploadArea');
            const fileInput = document.getElementById('gpxFileInput');

            if (!uploadArea || !fileInput) return;

            // ドラッグ＆ドロップ
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.gpx')) {
                    parseGpxFile(file);
                } else {
                    alert('GPXファイルを選択してください');
                }
            });

            // ファイル選択
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    parseGpxFile(file);
                }
            });

            // クリックでファイル選択
            uploadArea.addEventListener('click', (e) => {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                    fileInput.click();
                }
            });
        }

        function parseGpxFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const gpxContent = e.target.result;
                    const parser = new DOMParser();
                    const gpxDoc = parser.parseFromString(gpxContent, 'text/xml');
                    
                    const gpxData = analyzeGpx(gpxDoc, file.name);
                    displayGpxResult(gpxData);
                } catch (error) {
                    console.error('GPX解析エラー:', error);
                    alert('GPXファイルの解析に失敗しました');
                }
            };
            reader.readAsText(file);
        }

        function analyzeGpx(gpxDoc, fileName) {
            const trackPoints = gpxDoc.querySelectorAll('trkpt');
            const waypoints = gpxDoc.querySelectorAll('wpt');
            const trackName = gpxDoc.querySelector('trk > name')?.textContent || 
                              gpxDoc.querySelector('metadata > name')?.textContent ||
                              fileName.replace('.gpx', '');

            if (trackPoints.length === 0) {
                throw new Error('トラックポイントが見つかりません');
            }

            const points = [];
            let totalDistance = 0;
            let elevationGain = 0;
            let elevationLoss = 0;
            let minElevation = Infinity;
            let maxElevation = -Infinity;

            trackPoints.forEach((pt, index) => {
                const lat = parseFloat(pt.getAttribute('lat'));
                const lon = parseFloat(pt.getAttribute('lon'));
                const ele = parseFloat(pt.querySelector('ele')?.textContent || 0);
                const time = pt.querySelector('time')?.textContent;

                points.push({ lat, lon, ele, time });

                // 標高の最大/最小
                if (ele > maxElevation) maxElevation = ele;
                if (ele < minElevation) minElevation = ele;

                // 距離と累積標高の計算
                if (index > 0) {
                    const prevPoint = points[index - 1];
                    
                    // 距離計算（ハーバーサイン公式）
                    const dist = calculateDistance(prevPoint.lat, prevPoint.lon, lat, lon);
                    totalDistance += dist;

                    // 累積標高
                    const eleDiff = ele - prevPoint.ele;
                    if (eleDiff > 0) {
                        elevationGain += eleDiff;
                    } else {
                        elevationLoss += Math.abs(eleDiff);
                    }
                }
            });

            // 活動時間の計算
            let duration = 0;
            const firstTime = points[0]?.time;
            const lastTime = points[points.length - 1]?.time;
            if (firstTime && lastTime) {
                const startDate = new Date(firstTime);
                const endDate = new Date(lastTime);
                duration = (endDate - startDate) / 1000 / 60; // 分
            }

            currentGpxData = {
                name: trackName,
                date: firstTime ? new Date(firstTime) : new Date(),
                distance: totalDistance,
                elevationGain: elevationGain,
                elevationLoss: elevationLoss,
                maxElevation: maxElevation,
                minElevation: minElevation,
                duration: duration,
                pointCount: points.length
            };

            return currentGpxData;
        }

        // ハーバーサイン公式で2点間の距離を計算（km）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球の半径（km）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function displayGpxResult(data) {
            document.getElementById('gpxUploadArea').style.display = 'none';
            document.getElementById('gpxResult').style.display = 'block';

            document.getElementById('gpxName').textContent = data.name;
            document.getElementById('gpxDate').textContent = data.date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('gpxDistance').textContent = data.distance.toFixed(2) + ' km';
            document.getElementById('gpxElevationGain').textContent = Math.round(data.elevationGain) + ' m';
            document.getElementById('gpxElevationLoss').textContent = Math.round(data.elevationLoss) + ' m';
            document.getElementById('gpxMaxElevation').textContent = Math.round(data.maxElevation) + ' m';
            document.getElementById('gpxMinElevation').textContent = Math.round(data.minElevation) + ' m';
            
            // 活動時間のフォーマット
            const hours = Math.floor(data.duration / 60);
            const minutes = Math.round(data.duration % 60);
            document.getElementById('gpxDuration').textContent = 
                hours > 0 ? `${hours}時間${minutes}分` : `${minutes}分`;
        }

        function resetGpxUpload() {
            currentGpxData = null;
            document.getElementById('gpxUploadArea').style.display = 'block';
            document.getElementById('gpxResult').style.display = 'none';
            document.getElementById('gpxFileInput').value = '';
            document.getElementById('gpxMemo').value = '';
        }

        async function saveHikingRecord() {
            if (!currentGpxData) {
                alert('GPXデータがありません');
                return;
            }

            const memo = document.getElementById('gpxMemo').value;

            const data = {
                name: currentGpxData.name,
                date: currentGpxData.date.toISOString(),
                distance: currentGpxData.distance,
                elevationGain: currentGpxData.elevationGain,
                elevationLoss: currentGpxData.elevationLoss,
                maxElevation: currentGpxData.maxElevation,
                minElevation: currentGpxData.minElevation,
                duration: currentGpxData.duration,
                memo: memo
            };

            const success = await saveRecord('hiking', data, 30);
            
            if (success) {
                await addXP(30);
                resetGpxUpload();
                renderHikingHistory();
                showToast('登山記録を保存しました！ +30 XP');
            }
        }

        function renderHikingHistory() {
            const container = document.getElementById('hikingHistory');
            const hikingRecords = historyData.filter(h => h.type === 'hiking');

            if (hikingRecords.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">登山記録はまだありません</p>';
                return;
            }

            container.innerHTML = hikingRecords.map(record => {
                const date = new Date(record.date);
                const dateStr = date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                return `
                    <div class="hiking-item">
                        <div class="hiking-icon">🏔️</div>
                        <div class="hiking-info">
                            <div class="hiking-name">${record.name || '名称未設定'}</div>
                            <div class="hiking-details">
                                📏 ${(record.distance || 0).toFixed(1)}km　
                                ⬆️ ${Math.round(record.elevationGain || 0)}m　
                                ⏱️ ${formatDuration(record.duration || 0)}
                            </div>
                        </div>
                        <div class="hiking-date">${dateStr}</div>
                    </div>
                `;
            }).join('');
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return hours > 0 ? `${hours}h${mins}m` : `${mins}m`;
        }

        // ============================================
        // お気に入り機能
        // ============================================
        let favoritesData = {
            training: [],
            stretch: [],
            cooking: [],
            music: [],
            other: []
        };
        const MAX_FAVORITES = 12;

        function loadFavorites() {
            // 古いデータ形式からの移行
            const oldData = localStorage.getItem('lifecompass_favorites_' + userId);
            if (oldData) {
                try {
                    const oldFavorites = JSON.parse(oldData);
                    if (Array.isArray(oldFavorites) && oldFavorites.length > 0) {
                        // 古いデータを「その他」カテゴリに移行
                        favoritesData.other = oldFavorites;
                        saveFavoritesToStorage('other');
                        // 古いキーを削除
                        localStorage.removeItem('lifecompass_favorites_' + userId);
                        console.log('古いお気に入りデータを移行しました');
                    }
                } catch (e) {
                    console.log('古いデータの移行をスキップ');
                }
            }
            
            const categories = ['training', 'stretch', 'cooking', 'music', 'other'];
            categories.forEach(cat => {
                const saved = localStorage.getItem(`lifecompass_favorites_${cat}_${userId}`);
                if (saved) {
                    favoritesData[cat] = JSON.parse(saved);
                } else {
                    favoritesData[cat] = [];
                }
            });
            renderAllFavorites();
        }

        function saveFavoritesToStorage(category) {
            localStorage.setItem(`lifecompass_favorites_${category}_${userId}`, JSON.stringify(favoritesData[category] || []));
        }

        function renderAllFavorites() {
            const categories = {
                'training': 'Training',
                'stretch': 'Stretch',
                'cooking': 'Cooking',
                'music': 'Music',
                'other': 'Other'
            };
            
            Object.keys(categories).forEach(cat => {
                renderFavoriteCategory(cat);
            });
        }

        function renderFavoriteCategory(category) {
            const container = document.getElementById(`favoritesGrid${category.charAt(0).toUpperCase() + category.slice(1)}`);
            const countEl = document.getElementById(`favoriteCount${category.charAt(0).toUpperCase() + category.slice(1)}`);
            
            if (!container) return;
            
            const data = favoritesData[category] || [];
            countEl.textContent = `${data.length}/${MAX_FAVORITES}`;
            
            if (data.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px; grid-column: 1/-1;">まだ登録されていません</p>';
                return;
            }
            
            container.innerHTML = data.map((fav, index) => `
                <a href="${fav.url}" target="_blank" class="favorite-btn" title="${fav.url}">
                    <button class="favorite-delete" onclick="deleteFavorite('${category}', ${index}, event)">×</button>
                    <div class="favorite-icon">${fav.icon}</div>
                    <div class="favorite-name">${fav.name}</div>
                </a>
            `).join('');
        }

        function showAddFavoriteForm(category) {
            document.getElementById('favoriteCategory').value = category;
            
            const titles = {
                'training': '🏋️ トレーニング動画を追加',
                'stretch': '🧘 ストレッチ動画を追加',
                'cooking': '🍳 料理動画を追加',
                'music': '🎵 音楽を追加',
                'other': '⭐ リンクを追加'
            };
            document.getElementById('addFavoriteTitle').textContent = titles[category] || 'リンクを追加';
            
            document.getElementById('addFavoriteModal').classList.add('active');
            setupEmojiPicker();
        }

        function closeAddFavoriteModal() {
            document.getElementById('addFavoriteModal').classList.remove('active');
            document.getElementById('favoriteName').value = '';
            document.getElementById('favoriteUrl').value = '';
        }

        function setupEmojiPicker() {
            document.querySelectorAll('#emojiPicker .emoji-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('#emojiPicker .emoji-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        }

        function addFavorite() {
            const category = document.getElementById('favoriteCategory').value;
            
            if (!favoritesData[category]) {
                favoritesData[category] = [];
            }
            
            if (favoritesData[category].length >= MAX_FAVORITES) {
                alert(`各カテゴリのお気に入りは${MAX_FAVORITES}個までです`);
                return;
            }

            const name = document.getElementById('favoriteName').value.trim();
            let url = document.getElementById('favoriteUrl').value.trim();
            const selectedEmoji = document.querySelector('#emojiPicker .emoji-option.selected');
            const icon = selectedEmoji ? selectedEmoji.dataset.emoji : '⭐';

            if (!name) {
                alert('タイトルを入力してください');
                return;
            }

            if (!url) {
                alert('URLを入力してください');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            favoritesData[category].push({ name, url, icon });
            saveFavoritesToStorage(category);
            renderFavoriteCategory(category);
            closeAddFavoriteModal();

            showToast('お気に入りを追加しました！');
        }

        function deleteFavorite(category, index, event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (confirm('このお気に入りを削除しますか？')) {
                favoritesData[category].splice(index, 1);
                saveFavoritesToStorage(category);
                renderFavoriteCategory(category);
                showToast('お気に入りを削除しました');
            }
        }

        // ============================================
        // ダイエットメニュー生成
        // ============================================
        let currentDietMenu = null;
        let dietMenuHistory = [];
        let selectedSavedMenuIndex = null;

        function loadDietMenuHistory() {
            const saved = localStorage.getItem(`lifecompass_diet_history_${userId}`);
            if (saved) {
                dietMenuHistory = JSON.parse(saved);
            }
            renderDietHistory();
        }

        function saveDietMenuHistory() {
            localStorage.setItem(`lifecompass_diet_history_${userId}`, JSON.stringify(dietMenuHistory));
        }

        function renderDietHistory() {
            const container = document.getElementById('dietHistoryList');
            const countEl = document.getElementById('dietHistoryCount');
            
            if (!container) return;
            
            countEl.textContent = `${dietMenuHistory.length}件`;
            
            if (dietMenuHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">保存したメニューはありません</p>';
                return;
            }
            
            container.innerHTML = dietMenuHistory.map((item, index) => {
                const date = new Date(item.savedAt);
                const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                const restrictionLabels = {
                    'none': 'なし',
                    'low_carb': '低糖質',
                    'low_fat': '低脂質',
                    'high_protein': '高タンパク',
                    'vegetarian': 'ベジタリアン'
                };
                return `
                    <div class="diet-history-item" onclick="showSavedMenu(${index})">
                        <div class="diet-history-info">
                            <div class="diet-history-date">📅 ${dateStr}</div>
                            <div class="diet-history-meta">${item.calories}kcal / ${restrictionLabels[item.restriction] || 'なし'}</div>
                        </div>
                        <div class="diet-history-arrow">›</div>
                    </div>
                `;
            }).join('');
        }

        async function generateDietMenu() {
            const calories = document.getElementById('dietCalories').value || 1500;
            const restriction = document.getElementById('dietRestriction').value;
            const preferences = document.getElementById('dietPreferences').value;
            
            const apiKey = localStorage.getItem('lifecompass_gemini_key');
            if (!apiKey) {
                alert('Gemini APIキーを設定してください（AI分析タブで設定できます）');
                return;
            }
            
            const resultDiv = document.getElementById('dietResult');
            const container = document.getElementById('dietMenuContainer');
            
            resultDiv.style.display = 'block';
            container.innerHTML = '<div class="diet-loading"><div class="analysis-loading-spinner"></div><p>メニューを生成中...</p></div>';
            
            const restrictionText = {
                'none': '',
                'low_carb': '低糖質（1日の糖質を50g以下）',
                'low_fat': '低脂質',
                'high_protein': '高タンパク（1日のタンパク質を体重×1.5g以上）',
                'vegetarian': 'ベジタリアン（肉・魚不使用）'
            };
            
            const prompt = `あなたは栄養士です。以下の条件で1週間分（月曜日〜日曜日）のダイエットメニューを作成してください。

【条件】
- 1日の目標カロリー: 約${calories}kcal
${restrictionText[restriction] ? `- 制限: ${restrictionText[restriction]}` : ''}
${preferences ? `- 好み/避けたい食材: ${preferences}` : ''}

【形式】
JSON形式で、以下の構造で出力してください：
{
  "menu": [
    {
      "day": "月曜日",
      "totalCalories": 1500,
      "meals": [
        {"type": "朝食", "name": "オートミール", "details": "牛乳、バナナ、蜂蜜", "calories": 350, "ingredients": ["オートミール", "牛乳", "バナナ", "蜂蜜"]},
        {"type": "昼食", "name": "サラダチキン丼", "details": "玄米、サラダチキン、野菜", "calories": 500, "ingredients": ["玄米", "鶏むね肉", "レタス", "トマト"]},
        {"type": "夕食", "name": "鮭の塩焼き定食", "details": "鮭、味噌汁、ほうれん草おひたし", "calories": 550, "ingredients": ["鮭", "味噌", "豆腐", "ほうれん草"]},
        {"type": "間食", "name": "プロテイン", "details": "プロテインシェイク", "calories": 100, "ingredients": ["プロテインパウダー", "牛乳"]}
      ]
    }
  ],
  "tips": "バランスの良い食事を心がけましょう",
  "shoppingList": {
    "肉・魚": ["鶏むね肉 700g", "鮭 4切れ"],
    "野菜": ["レタス 1玉", "トマト 4個", "ほうれん草 2束"],
    "乳製品": ["牛乳 2L", "ヨーグルト 500g"],
    "その他": ["オートミール 500g", "玄米 2kg", "味噌 1パック"]
  }
}

JSONのみを出力してください。`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
                    })
                });
                
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('メニューの生成に失敗しました');
                
                const menuData = JSON.parse(jsonMatch[0]);
                currentDietMenu = {
                    ...menuData,
                    calories: calories,
                    restriction: restriction,
                    preferences: preferences
                };
                renderDietMenu(menuData);
                
            } catch (error) {
                console.error('Diet menu error:', error);
                container.innerHTML = '<p style="color: var(--accent-magenta); text-align: center;">メニューの生成に失敗しました。もう一度お試しください。</p>';
            }
        }

        function renderDietMenu(menuData) {
            const container = document.getElementById('dietMenuContainer');
            
            const mealIcons = {
                '朝食': '🌅',
                '昼食': '☀️',
                '夕食': '🌙',
                '間食': '🍎'
            };
            
            let html = menuData.menu.map(day => `
                <div class="diet-day">
                    <div class="diet-day-header">
                        <div class="diet-day-title">📅 ${day.day}</div>
                        <div class="diet-day-calories">${day.totalCalories} kcal</div>
                    </div>
                    <div class="diet-meals">
                        ${day.meals.map(meal => `
                            <div class="diet-meal">
                                <div class="diet-meal-type">${mealIcons[meal.type] || '🍽️'}</div>
                                <div class="diet-meal-content">
                                    <div class="diet-meal-name">${meal.name}</div>
                                    <div class="diet-meal-details">${meal.details} (${meal.calories}kcal)</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            if (menuData.tips) {
                html += `<div class="card" style="margin-top: 15px; background: rgba(0, 212, 255, 0.1); border: 1px solid var(--accent-cyan);">
                    <p>💡 <strong>アドバイス:</strong> ${menuData.tips}</p>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        function saveDietMenu() {
            if (!currentDietMenu) {
                alert('保存するメニューがありません');
                return;
            }
            
            const menuToSave = {
                ...currentDietMenu,
                savedAt: new Date().toISOString()
            };
            
            dietMenuHistory.unshift(menuToSave);
            
            // 最大10件まで保存
            if (dietMenuHistory.length > 10) {
                dietMenuHistory = dietMenuHistory.slice(0, 10);
            }
            
            saveDietMenuHistory();
            renderDietHistory();
            showToast('メニューを保存しました！');
        }

        function showSavedMenu(index) {
            selectedSavedMenuIndex = index;
            const menu = dietMenuHistory[index];
            
            if (!menu) return;
            
            const date = new Date(menu.savedAt);
            const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            
            document.getElementById('savedMenuTitle').textContent = `📅 ${dateStr} のメニュー`;
            
            const mealIcons = {
                '朝食': '🌅',
                '昼食': '☀️',
                '夕食': '🌙',
                '間食': '🍎'
            };
            
            let html = menu.menu.map(day => `
                <div class="diet-day">
                    <div class="diet-day-header">
                        <div class="diet-day-title">📅 ${day.day}</div>
                        <div class="diet-day-calories">${day.totalCalories} kcal</div>
                    </div>
                    <div class="diet-meals">
                        ${day.meals.map(meal => `
                            <div class="diet-meal">
                                <div class="diet-meal-type">${mealIcons[meal.type] || '🍽️'}</div>
                                <div class="diet-meal-content">
                                    <div class="diet-meal-name">${meal.name}</div>
                                    <div class="diet-meal-details">${meal.details} (${meal.calories}kcal)</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('savedMenuBody').innerHTML = html;
            document.getElementById('savedMenuModal').classList.add('active');
        }

        function closeSavedMenuModal() {
            document.getElementById('savedMenuModal').classList.remove('active');
            selectedSavedMenuIndex = null;
        }

        function deleteSavedMenu() {
            if (selectedSavedMenuIndex === null) return;
            
            if (!confirm('このメニューを削除しますか？')) return;
            
            dietMenuHistory.splice(selectedSavedMenuIndex, 1);
            saveDietMenuHistory();
            renderDietHistory();
            closeSavedMenuModal();
            showToast('メニューを削除しました');
        }

        function generateShoppingList() {
            if (!currentDietMenu || !currentDietMenu.shoppingList) {
                alert('買い物リストがありません。メニューを再生成してください。');
                return;
            }
            
            showShoppingListModal(currentDietMenu.shoppingList);
        }

        function generateShoppingListFromSaved() {
            if (selectedSavedMenuIndex === null) return;
            
            const menu = dietMenuHistory[selectedSavedMenuIndex];
            if (!menu || !menu.shoppingList) {
                alert('買い物リストがありません');
                return;
            }
            
            closeSavedMenuModal();
            showShoppingListModal(menu.shoppingList);
        }

        function showShoppingListModal(shoppingList) {
            let html = '';
            
            for (const [category, items] of Object.entries(shoppingList)) {
                html += `
                    <div class="shopping-list-category">
                        <div class="shopping-list-title">${category}</div>
                        <div class="shopping-list-items">
                            ${items.map(item => `
                                <div class="shopping-list-item">
                                    <input type="checkbox" id="item_${item.replace(/\s/g, '_')}">
                                    <label for="item_${item.replace(/\s/g, '_')}">${item}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('shoppingListBody').innerHTML = html;
            document.getElementById('shoppingListModal').classList.add('active');
        }

        function closeShoppingListModal() {
            document.getElementById('shoppingListModal').classList.remove('active');
        }

        function copyShoppingList() {
            const shoppingList = currentDietMenu?.shoppingList || 
                (selectedSavedMenuIndex !== null ? dietMenuHistory[selectedSavedMenuIndex]?.shoppingList : null);
            
            if (!shoppingList) {
                alert('コピーする買い物リストがありません');
                return;
            }
            
            let text = '🛒 1週間の買い物リスト\n\n';
            
            for (const [category, items] of Object.entries(shoppingList)) {
                text += `【${category}】\n`;
                items.forEach(item => {
                    text += `□ ${item}\n`;
                });
                text += '\n';
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('買い物リストをコピーしました！');
            }).catch(() => {
                alert('コピーに失敗しました');
            });
        }

        // ============================================
        // バイタル記録
        // ============================================
        async function saveVitals() {
            const height = parseFloat(document.getElementById('vitalHeight').value) || null;
            const weight = parseFloat(document.getElementById('vitalWeight').value) || null;
            const bodyFat = parseFloat(document.getElementById('vitalBodyFat').value) || null;
            const muscle = parseFloat(document.getElementById('vitalMuscle').value) || null;
            const bpHigh = parseInt(document.getElementById('vitalBpHigh').value) || null;
            const bpLow = parseInt(document.getElementById('vitalBpLow').value) || null;
            const heartRate = parseInt(document.getElementById('vitalHeartRate').value) || null;
            const temp = parseFloat(document.getElementById('vitalTemp').value) || null;
            const bloodSugar = parseInt(document.getElementById('vitalBloodSugar').value) || null;
            const spo2 = parseInt(document.getElementById('vitalSpO2').value) || null;
            const note = document.getElementById('vitalNote').value;
            
            // 少なくとも1つは入力が必要
            if (!height && !weight && !bodyFat && !muscle && !bpHigh && !bpLow && !heartRate && !temp && !bloodSugar && !spo2) {
                alert('少なくとも1つの項目を入力してください');
                return;
            }
            
            const data = {
                height, weight, bodyFat, muscle,
                bpHigh, bpLow, heartRate, temp,
                bloodSugar, spo2, note
            };
            
            const success = await saveRecord('vitals', data, 15);
            
            if (success) {
                await addXP(15);
                
                // 体重があれば更新
                if (weight) {
                    userData.currentWeight = weight;
                }
                
                // フォームをクリア
                ['vitalHeight', 'vitalWeight', 'vitalBodyFat', 'vitalMuscle', 
                 'vitalBpHigh', 'vitalBpLow', 'vitalHeartRate', 'vitalTemp',
                 'vitalBloodSugar', 'vitalSpO2', 'vitalNote'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                
                renderHistory();
                renderVitalChart();
                showToast('バイタルを記録しました！ +15 XP');
            }
        }

        function calculateBMI() {
            const height = parseFloat(document.getElementById('vitalHeight').value);
            const weight = parseFloat(document.getElementById('vitalWeight').value);
            
            if (!height || !weight) {
                alert('身長と体重を入力してください');
                return;
            }
            
            const heightM = height / 100;
            const bmi = weight / (heightM * heightM);
            
            document.querySelector('.bmi-value').textContent = bmi.toFixed(1);
            
            // BMI判定
            let status = '';
            if (bmi < 18.5) status = '低体重';
            else if (bmi < 25) status = '普通体重';
            else if (bmi < 30) status = '肥満(1度)';
            else if (bmi < 35) status = '肥満(2度)';
            else status = '肥満(3度以上)';
            
            document.getElementById('bmiStatus').textContent = status;
            
            // 基礎代謝（ハリス・ベネディクト方程式、男性想定）
            const bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * 40);
            document.getElementById('bmrValue').textContent = Math.round(bmr) + ' kcal';
            
            // 理想体重（BMI22）
            const idealWeight = 22 * heightM * heightM;
            document.getElementById('idealWeight').textContent = idealWeight.toFixed(1) + ' kg';
        }

        function renderVitalChart() {
            const container = document.getElementById('vitalChart');
            const labels = document.getElementById('vitalLabels');
            const chartType = document.getElementById('vitalChartType')?.value || 'weight';
            
            if (!container) return;
            
            // バイタルデータを抽出
            const vitalRecords = historyData
                .filter(r => r.type === 'vitals' || r.type === 'weight')
                .slice(0, 14)
                .reverse();
            
            if (vitalRecords.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:50px;">データがありません</div>';
                labels.innerHTML = '';
                return;
            }
            
            let values = [];
            let unit = '';
            
            switch(chartType) {
                case 'weight':
                    values = vitalRecords.map(r => r.weight || null);
                    unit = 'kg';
                    break;
                case 'bodyFat':
                    values = vitalRecords.map(r => r.bodyFat || null);
                    unit = '%';
                    break;
                case 'bp':
                    values = vitalRecords.map(r => r.bpHigh || null);
                    unit = 'mmHg';
                    break;
                case 'heartRate':
                    values = vitalRecords.map(r => r.heartRate || null);
                    unit = 'bpm';
                    break;
            }
            
            const validValues = values.filter(v => v !== null);
            if (validValues.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:50px;">データがありません</div>';
                return;
            }
            
            const minVal = Math.min(...validValues) * 0.95;
            const maxVal = Math.max(...validValues) * 1.05;
            const range = maxVal - minVal || 1;
            
            container.innerHTML = values.map((val, i) => {
                if (val === null) return '<div class="chart-bar" style="height: 0;"></div>';
                const height = ((val - minVal) / range) * 180;
                return `<div class="chart-bar" style="height: ${height}px; background: var(--gradient-main);" data-value="${val}${unit}"></div>`;
            }).join('');
            
            labels.innerHTML = vitalRecords.map(record => {
                const date = new Date(record.date);
                return `<div class="chart-label">${date.getMonth() + 1}/${date.getDate()}</div>`;
            }).join('');
        }

        // ============================================
        // リマインダー機能
        // ============================================
        let remindersData = [];
        const MAX_REMINDERS = 10;
        let reminderCheckInterval = null;
        let currentReminderSound = null;
        let snoozeTimeout = null;

        // AudioContextを使用した音声生成
        let audioContext = null;

        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playReminderSound(soundType) {
            if (soundType === 'none') return;
            
            try {
                const ctx = getAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                switch(soundType) {
                    case 'bell':
                        // ベル音（高音で減衰）
                        oscillator.frequency.setValueAtTime(880, ctx.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.5);
                        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.5);
                        // 2回目
                        setTimeout(() => playBellOnce(ctx), 600);
                        break;
                    case 'chime':
                        // チャイム（和音）
                        playChime(ctx);
                        break;
                    case 'alert':
                        // アラート（急な音）
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(600, ctx.currentTime);
                        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.1);
                        setTimeout(() => {
                            const osc2 = ctx.createOscillator();
                            const gain2 = ctx.createGain();
                            osc2.connect(gain2);
                            gain2.connect(ctx.destination);
                            osc2.type = 'square';
                            osc2.frequency.setValueAtTime(800, ctx.currentTime);
                            gain2.gain.setValueAtTime(0.2, ctx.currentTime);
                            osc2.start(ctx.currentTime);
                            osc2.stop(ctx.currentTime + 0.1);
                        }, 150);
                        break;
                }
            } catch (e) {
                console.log('Audio playback failed:', e);
            }
        }

        function playBellOnce(ctx) {
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            oscillator.frequency.setValueAtTime(880, ctx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.5);
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.5);
        }

        function playChime(ctx) {
            const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
            frequencies.forEach((freq, i) => {
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, ctx.currentTime);
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.8);
                }, i * 200);
            });
        }

        function loadReminders() {
            const saved = localStorage.getItem('lifecompass_reminders_' + userId);
            if (saved) {
                remindersData = JSON.parse(saved);
            }
            renderReminders();
            checkNotificationPermission();
            startReminderChecker();
            setupWeekdayPicker();
            setupCategorySelect();
        }

        function saveRemindersToStorage() {
            localStorage.setItem('lifecompass_reminders_' + userId, JSON.stringify(remindersData));
        }

        function checkNotificationPermission() {
            const permissionEl = document.getElementById('reminderPermission');
            if (!permissionEl) return;
            
            if (!('Notification' in window)) {
                permissionEl.innerHTML = '<p style="color: var(--accent-orange);">このブラウザは通知に対応していません</p>';
                return;
            }
            
            if (Notification.permission === 'granted') {
                permissionEl.innerHTML = '<p style="color: var(--accent-green);">✓ 通知が許可されています</p>';
                permissionEl.classList.add('granted');
            } else if (Notification.permission === 'denied') {
                permissionEl.innerHTML = '<p style="color: var(--accent-magenta);">通知がブロックされています。ブラウザの設定から許可してください。</p>';
            }
        }

        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('このブラウザは通知に対応していません');
                return;
            }
            
            const permission = await Notification.requestPermission();
            checkNotificationPermission();
            
            if (permission === 'granted') {
                showToast('通知が許可されました！');
            }
        }

        function setupWeekdayPicker() {
            document.querySelectorAll('.weekday-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('selected');
                });
            });
        }

        function setupCategorySelect() {
            const categorySelect = document.getElementById('reminderCategory');
            const customGroup = document.getElementById('customMessageGroup');
            
            if (categorySelect && customGroup) {
                categorySelect.addEventListener('change', () => {
                    if (categorySelect.value === 'custom') {
                        customGroup.style.display = 'block';
                    } else {
                        customGroup.style.display = 'none';
                    }
                });
            }
        }

        function renderReminders() {
            const container = document.getElementById('reminderList');
            const countEl = document.getElementById('reminderCount');
            
            if (!container) return;
            
            countEl.textContent = `${remindersData.length}/${MAX_REMINDERS}`;
            
            if (remindersData.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">リマインダーがまだありません</p>';
                return;
            }
            
            const categoryInfo = {
                training: { icon: '🏋️', name: 'トレーニング' },
                meal: { icon: '🍽️', name: '食事' },
                steps: { icon: '👣', name: '歩数' },
                weight: { icon: '⚖️', name: '体重' },
                water: { icon: '💧', name: '水分補給' },
                stretch: { icon: '🧘', name: 'ストレッチ' },
                medicine: { icon: '💊', name: '薬' },
                sleep: { icon: '😴', name: '就寝' },
                custom: { icon: '📝', name: 'カスタム' }
            };
            
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            
            container.innerHTML = remindersData.map((reminder, index) => {
                const info = categoryInfo[reminder.category] || categoryInfo.custom;
                const daysText = reminder.days.map(d => dayNames[d]).join(' ');
                const displayName = reminder.category === 'custom' ? reminder.message : info.name;
                
                return `
                    <div class="reminder-item">
                        <div class="reminder-time">${reminder.time}</div>
                        <div class="reminder-info">
                            <div class="reminder-category">${info.icon} ${displayName}</div>
                            <div class="reminder-days">${daysText}</div>
                        </div>
                        <div class="reminder-toggle ${reminder.enabled ? 'active' : ''}" onclick="toggleReminder(${index})"></div>
                        <button class="reminder-delete" onclick="deleteReminder(${index})">🗑️</button>
                    </div>
                `;
            }).join('');
        }

        function addReminder() {
            if (remindersData.length >= MAX_REMINDERS) {
                alert(`リマインダーは${MAX_REMINDERS}個までです`);
                return;
            }

            const time = document.getElementById('reminderTime').value;
            const category = document.getElementById('reminderCategory').value;
            const message = document.getElementById('reminderMessage')?.value || '';
            const sound = document.querySelector('input[name="reminderSound"]:checked')?.value || 'bell';
            
            const selectedDays = [];
            document.querySelectorAll('.weekday-btn.selected').forEach(btn => {
                selectedDays.push(parseInt(btn.dataset.day));
            });

            if (!time) {
                alert('時刻を設定してください');
                return;
            }

            if (selectedDays.length === 0) {
                alert('曜日を選択してください');
                return;
            }

            if (category === 'custom' && !message) {
                alert('メッセージを入力してください');
                return;
            }

            remindersData.push({
                id: Date.now(),
                time,
                category,
                message,
                days: selectedDays,
                sound,
                enabled: true,
                lastTriggered: null
            });

            saveRemindersToStorage();
            renderReminders();
            showToast('リマインダーを追加しました！');

            // フォームをリセット
            document.getElementById('reminderTime').value = '08:00';
            document.getElementById('reminderCategory').value = 'training';
            if (document.getElementById('reminderMessage')) {
                document.getElementById('reminderMessage').value = '';
            }
            document.getElementById('customMessageGroup').style.display = 'none';
        }

        function toggleReminder(index) {
            remindersData[index].enabled = !remindersData[index].enabled;
            saveRemindersToStorage();
            renderReminders();
        }

        function deleteReminder(index) {
            if (confirm('このリマインダーを削除しますか？')) {
                remindersData.splice(index, 1);
                saveRemindersToStorage();
                renderReminders();
                showToast('リマインダーを削除しました');
            }
        }

        function startReminderChecker() {
            // 1分ごとにチェック
            if (reminderCheckInterval) {
                clearInterval(reminderCheckInterval);
            }
            
            reminderCheckInterval = setInterval(checkReminders, 60000);
            // 初回もチェック
            checkReminders();
        }

        function checkReminders() {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5); // HH:MM形式
            const currentDay = now.getDay();
            const todayDate = now.toDateString();

            remindersData.forEach((reminder, index) => {
                if (!reminder.enabled) return;
                if (!reminder.days.includes(currentDay)) return;
                if (reminder.time !== currentTime) return;
                if (reminder.lastTriggered === todayDate) return;

                // リマインダーを発動
                triggerReminder(reminder, index);
                
                // 発動済みとしてマーク
                remindersData[index].lastTriggered = todayDate;
                saveRemindersToStorage();
            });
        }

        function triggerReminder(reminder) {
            const categoryInfo = {
                training: { icon: '🏋️', name: 'トレーニング', message: 'トレーニングの時間です！' },
                meal: { icon: '🍽️', name: '食事', message: '食事の記録をしましょう！' },
                steps: { icon: '👣', name: '歩数', message: '歩数を記録しましょう！' },
                weight: { icon: '⚖️', name: '体重', message: '体重を測定しましょう！' },
                water: { icon: '💧', name: '水分補給', message: '水を飲みましょう！' },
                stretch: { icon: '🧘', name: 'ストレッチ', message: 'ストレッチの時間です！' },
                medicine: { icon: '💊', name: '薬', message: '薬を飲む時間です！' },
                sleep: { icon: '😴', name: '就寝', message: 'そろそろ寝る時間です！' },
                custom: { icon: '📝', name: 'リマインダー', message: reminder.message || 'リマインダー' }
            };

            const info = categoryInfo[reminder.category] || categoryInfo.custom;
            
            // アプリ内ポップアップを表示
            showReminderPopup(reminder, info);
            
            // ブラウザ通知も送信（許可されている場合）
            if (Notification.permission === 'granted') {
                new Notification(`${info.icon} ${info.name}`, {
                    body: reminder.category === 'custom' ? reminder.message : info.message,
                    icon: '🧭',
                    tag: 'reminder-' + reminder.id
                });
            }
            
            // 音を鳴らす
            playReminderSound(reminder.sound);
        }

        function showReminderPopup(reminder, info) {
            const popup = document.getElementById('reminderPopup');
            document.getElementById('reminderPopupIcon').textContent = info.icon;
            document.getElementById('reminderPopupTime').textContent = reminder.time;
            document.getElementById('reminderPopupTitle').textContent = info.name;
            document.getElementById('reminderPopupMessage').textContent = 
                reminder.category === 'custom' ? reminder.message : info.message;
            
            popup.classList.add('show');
            
            // 現在のリマインダーを保存（スヌーズ用）
            popup.dataset.reminderId = reminder.id;
            popup.dataset.reminderSound = reminder.sound;
        }

        function dismissReminder() {
            const popup = document.getElementById('reminderPopup');
            popup.classList.remove('show');
            if (snoozeTimeout) {
                clearTimeout(snoozeTimeout);
                snoozeTimeout = null;
            }
        }

        function snoozeReminder() {
            const popup = document.getElementById('reminderPopup');
            const sound = popup.dataset.reminderSound;
            
            popup.classList.remove('show');
            showToast('5分後に再通知します');
            
            snoozeTimeout = setTimeout(() => {
                const reminder = remindersData.find(r => r.id == popup.dataset.reminderId);
                if (reminder) {
                    triggerReminder(reminder);
                }
            }, 5 * 60 * 1000); // 5分後
        }

        // ============================================
        // AI分析機能
        // ============================================
        let analysisHistoryData = [];
        let currentAnalysis = null;

        function initAnalysis() {
            // 日付表示を更新
            const today = new Date();
            const dateStr = today.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            const dateDisplay = document.getElementById('analysisDateDisplay');
            if (dateDisplay) {
                dateDisplay.textContent = dateStr;
            }

            // APIキーを読み込み
            const savedApiKey = localStorage.getItem('lifecompass_gemini_key');
            if (savedApiKey) {
                const keyInput = document.getElementById('geminiApiKey');
                if (keyInput) keyInput.value = savedApiKey;
            }

            // 分析履歴を読み込み
            loadAnalysisHistory();

            // 今日のサマリーを表示
            renderTodaySummary();
        }

        function saveApiKey() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            if (!apiKey) {
                alert('APIキーを入力してください');
                return;
            }
            localStorage.setItem('lifecompass_gemini_key', apiKey);
            showToast('APIキーを保存しました！');
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('geminiApiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function loadAnalysisHistory() {
            const saved = localStorage.getItem('lifecompass_analysis_history_' + userId);
            if (saved) {
                analysisHistoryData = JSON.parse(saved);
            }
            renderAnalysisHistory();
        }

        function saveAnalysisHistory() {
            // 最新30件のみ保存
            if (analysisHistoryData.length > 30) {
                analysisHistoryData = analysisHistoryData.slice(-30);
            }
            localStorage.setItem('lifecompass_analysis_history_' + userId, JSON.stringify(analysisHistoryData));
        }

        function renderTodaySummary() {
            const summary = document.getElementById('analysisSummary');
            if (!summary) return;

            const today = new Date().toISOString().split('T')[0];
            const todayRecords = historyData.filter(r => r.date && r.date.startsWith(today));

            if (todayRecords.length === 0) {
                summary.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                        今日の記録がまだありません。<br>記録を追加してから分析しましょう！
                    </p>
                `;
                return;
            }

            // 各種カウント
            const training = todayRecords.filter(r => r.type === 'training').length;
            const meals = todayRecords.filter(r => r.type === 'meal').length;
            const steps = todayRecords.find(r => r.type === 'steps')?.steps || 0;
            const alcohol = todayRecords.filter(r => r.type === 'alcohol');
            const alcoholTotal = alcohol.reduce((sum, r) => sum + (r.pureAlcohol || 0), 0);
            const hiking = todayRecords.filter(r => r.type === 'hiking').length;
            const totalXP = todayRecords.reduce((sum, r) => sum + (r.xp || 0), 0);

            summary.innerHTML = `
                <div class="analysis-summary-grid">
                    <div class="analysis-summary-item">
                        <div class="analysis-summary-icon">🏋️</div>
                        <div class="analysis-summary-value">${training}</div>
                        <div class="analysis-summary-label">トレーニング</div>
                    </div>
                    <div class="analysis-summary-item">
                        <div class="analysis-summary-icon">🍽️</div>
                        <div class="analysis-summary-value">${meals}</div>
                        <div class="analysis-summary-label">食事</div>
                    </div>
                    <div class="analysis-summary-item">
                        <div class="analysis-summary-icon">👣</div>
                        <div class="analysis-summary-value">${steps.toLocaleString()}</div>
                        <div class="analysis-summary-label">歩数</div>
                    </div>
                    <div class="analysis-summary-item">
                        <div class="analysis-summary-icon">🍺</div>
                        <div class="analysis-summary-value">${alcoholTotal.toFixed(0)}g</div>
                        <div class="analysis-summary-label">アルコール</div>
                    </div>
                    ${hiking > 0 ? `
                    <div class="analysis-summary-item">
                        <div class="analysis-summary-icon">🥾</div>
                        <div class="analysis-summary-value">${hiking}</div>
                        <div class="analysis-summary-label">登山</div>
                    </div>
                    ` : ''}
                    <div class="analysis-summary-item">
                        <div class="analysis-summary-icon">✨</div>
                        <div class="analysis-summary-value">${totalXP}</div>
                        <div class="analysis-summary-label">獲得XP</div>
                    </div>
                </div>
            `;
        }

        async function analyzeToday() {
            const apiKey = localStorage.getItem('lifecompass_gemini_key');
            if (!apiKey) {
                alert('Gemini APIキーを設定してください');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const todayRecords = historyData.filter(r => r.date && r.date.startsWith(today));

            if (todayRecords.length === 0) {
                alert('今日の記録がありません。まず記録を追加してください。');
                return;
            }

            // ローディング表示
            const resultCard = document.getElementById('analysisResultCard');
            const resultDiv = document.getElementById('analysisResult');
            resultCard.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="analysis-loading">
                    <div class="analysis-loading-spinner"></div>
                    <p>AIが分析中...</p>
                </div>
            `;

            try {
                const analysis = await callGeminiAPI(todayRecords, apiKey);
                currentAnalysis = analysis;
                displayAnalysisResult(analysis);

                // 履歴に保存
                analysisHistoryData.push({
                    date: today,
                    score: analysis.score,
                    summary: analysis.summary,
                    timestamp: Date.now()
                });
                saveAnalysisHistory();
                renderAnalysisHistory();

            } catch (error) {
                console.error('Analysis error:', error);
                resultDiv.innerHTML = `
                    <div style="color: var(--accent-magenta); text-align: center; padding: 20px;">
                        <p>分析中にエラーが発生しました</p>
                        <p style="font-size: 0.85rem; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function callGeminiAPI(records, apiKey) {
            // レコードを整形
            const recordsSummary = records.map(r => {
                switch (r.type) {
                    case 'training':
                        let detail = r.exercise || 'トレーニング';
                        if (r.strengthMenus && r.strengthMenus.length > 0) {
                            detail += ` (${r.strengthMenus.join(', ')})`;
                        }
                        return `・トレーニング: ${detail} ${r.duration || ''}分`;
                    case 'meal':
                        return `・食事(${r.mealType || ''}): ${r.content || ''}`;
                    case 'steps':
                        return `・歩数: ${r.steps}歩`;
                    case 'weight':
                        return `・体重: ${r.weight}kg`;
                    case 'alcohol':
                        return `・飲酒: ${r.drinkName || r.drink} ${r.ml || ''}ml (純アルコール${(r.pureAlcohol || 0).toFixed(1)}g)`;
                    case 'hiking':
                        return `・登山: ${r.name || ''} ${(r.distance || 0).toFixed(1)}km`;
                    case 'other':
                        return `・その他(${r.category || ''}): ${r.content || ''}`;
                    default:
                        return `・${r.type}: 記録あり`;
                }
            }).join('\n');

            const prompt = `あなたは健康管理アドバイザーです。以下の1日の活動記録を分析して、日本語で簡潔にフィードバックしてください。

【今日の活動記録】
${recordsSummary}

以下のJSON形式で回答してください：
{
  "score": 数値(0-100の健康スコア),
  "summary": "一行の総評",
  "goodPoints": ["良かった点1", "良かった点2"],
  "improvements": ["改善点1", "改善点2"],
  "advice": "明日へのアドバイス（1-2文）",
  "emoji": "今日を表す絵文字1つ"
}

注意：
- スコアは活動量、バランス、健康的な選択を考慮
- 歩数8000歩以上、飲酒20g以下を目安に
- ポジティブで励ます口調で
- JSONのみを出力`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 1024
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API呼び出しに失敗しました');
            }

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            
            // JSONを抽出
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('AIからの応答を解析できませんでした');
            }

            return JSON.parse(jsonMatch[0]);
        }

        function displayAnalysisResult(analysis) {
            const resultDiv = document.getElementById('analysisResult');
            
            // スコアに応じたクラス
            let scoreClass = 'score-low';
            if (analysis.score >= 80) scoreClass = 'score-excellent';
            else if (analysis.score >= 60) scoreClass = 'score-good';
            else if (analysis.score >= 40) scoreClass = 'score-average';

            resultDiv.innerHTML = `
                <div class="analysis-score">
                    <div class="analysis-score-circle ${scoreClass}">
                        <div class="analysis-score-value">${analysis.score}</div>
                        <div class="analysis-score-label">TODAY'S SCORE</div>
                    </div>
                    <div style="font-size: 3rem;">${analysis.emoji || '📊'}</div>
                </div>
                
                <p style="text-align: center; font-size: 1.1rem; margin-bottom: 20px;">
                    ${analysis.summary}
                </p>

                <h4>✨ 良かった点</h4>
                <ul>
                    ${(analysis.goodPoints || []).map(p => `<li>👍 ${p}</li>`).join('')}
                </ul>

                <h4>📈 改善できる点</h4>
                <ul>
                    ${(analysis.improvements || []).map(p => `<li>💡 ${p}</li>`).join('')}
                </ul>

                <h4>🎯 明日へのアドバイス</h4>
                <p>${analysis.advice || ''}</p>
            `;
        }

        function addToGoogleCalendar() {
            if (!currentAnalysis) {
                alert('まず分析を実行してください');
                return;
            }

            const today = new Date();
            const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
            
            // カレンダーイベントのタイトルと説明
            const title = `📊 健康スコア: ${currentAnalysis.score}点 ${currentAnalysis.emoji || ''}`;
            
            const description = `【${currentAnalysis.summary}】

✨ 良かった点
${(currentAnalysis.goodPoints || []).map(p => `・${p}`).join('\n')}

📈 改善点
${(currentAnalysis.improvements || []).map(p => `・${p}`).join('\n')}

🎯 アドバイス
${currentAnalysis.advice || ''}

---
ライフコンパスで記録`;

            // Google Calendar URL
            const calendarUrl = new URL('https://calendar.google.com/calendar/render');
            calendarUrl.searchParams.set('action', 'TEMPLATE');
            calendarUrl.searchParams.set('text', title);
            calendarUrl.searchParams.set('dates', `${dateStr}/${dateStr}`);
            calendarUrl.searchParams.set('details', description);

            window.open(calendarUrl.toString(), '_blank');
            showToast('Googleカレンダーを開きました');
        }

        function renderAnalysisHistory() {
            const container = document.getElementById('analysisHistory');
            if (!container) return;

            if (analysisHistoryData.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">分析履歴はまだありません</p>';
                return;
            }

            // 新しい順にソート
            const sorted = [...analysisHistoryData].sort((a, b) => b.timestamp - a.timestamp);

            container.innerHTML = sorted.map(item => {
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                
                let scoreClass = 'var(--accent-magenta)';
                if (item.score >= 80) scoreClass = 'var(--accent-green)';
                else if (item.score >= 60) scoreClass = 'var(--accent-cyan)';
                else if (item.score >= 40) scoreClass = 'var(--accent-orange)';

                return `
                    <div class="analysis-history-item" onclick="viewHistoryAnalysis('${item.date}')">
                        <div class="analysis-history-date">${dateStr}</div>
                        <div class="analysis-history-score">
                            <span style="color: ${scoreClass}; font-weight: bold;">${item.score}点</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewHistoryAnalysis(date) {
            const item = analysisHistoryData.find(a => a.date === date);
            if (item) {
                alert(`${date}の分析\n\nスコア: ${item.score}点\n${item.summary}`);
            }
        }

        // ========================================
        // 過去の記録入力機能
        // ========================================
        
        // 日付入力の初期化（昨日をデフォルトに）
        function initPastRecordDate() {
            const dateInput = document.getElementById('pastRecordDate');
            if (dateInput) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                dateInput.value = yesterday.toISOString().split('T')[0];
                dateInput.max = new Date().toISOString().split('T')[0]; // 今日まで
            }
        }
        
        // お酒入力欄の表示切替
        function togglePastAlcoholInputs() {
            const alcoholInputs = document.getElementById('pastAlcoholInputs');
            const drinkRadio = document.querySelector('input[name="pastAlcohol"][value="drink"]');
            if (alcoholInputs && drinkRadio) {
                alcoholInputs.style.display = drinkRadio.checked ? 'block' : 'none';
            }
        }
        
        // 過去の日付のGoogle Fit歩数を取得
        async function fetchPastGoogleFitSteps() {
            const dateInput = document.getElementById('pastRecordDate');
            const btn = document.getElementById('pastGoogleFitBtn');
            const status = document.getElementById('pastGoogleFitStatus');
            const stepsInput = document.getElementById('pastSteps');
            
            if (!dateInput || !dateInput.value) {
                status.textContent = '日付を選択してください';
                status.className = 'google-fit-status error';
                return;
            }
            
            if (!googleFitAccessToken) {
                // 認証が必要
                status.textContent = 'まず「歩数」タブでGoogle Fit認証を行ってください';
                status.className = 'google-fit-status error';
                return;
            }
            
            btn.classList.add('loading');
            document.getElementById('pastGoogleFitBtnText').textContent = '取得中...';
            
            try {
                const selectedDate = new Date(dateInput.value);
                const startOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
                const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000 - 1);
                
                const response = await fetch('https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + googleFitAccessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        aggregateBy: [{
                            dataTypeName: 'com.google.step_count.delta',
                            dataSourceId: 'derived:com.google.step_count.delta:com.google.android.gms:estimated_steps'
                        }],
                        bucketByTime: { durationMillis: 86400000 },
                        startTimeMillis: startOfDay.getTime(),
                        endTimeMillis: endOfDay.getTime()
                    })
                });
                
                if (response.status === 401) {
                    googleFitAccessToken = null;
                    localStorage.removeItem('lifecompass_googlefit_token');
                    status.textContent = '認証が切れました。「歩数」タブで再認証してください';
                    status.className = 'google-fit-status error';
                    btn.classList.remove('loading');
                    document.getElementById('pastGoogleFitBtnText').textContent = '選択した日の歩数を取得';
                    return;
                }
                
                const data = await response.json();
                
                let totalSteps = 0;
                if (data.bucket && data.bucket.length > 0) {
                    data.bucket.forEach(bucket => {
                        if (bucket.dataset && bucket.dataset.length > 0) {
                            bucket.dataset.forEach(dataset => {
                                if (dataset.point && dataset.point.length > 0) {
                                    dataset.point.forEach(point => {
                                        if (point.value && point.value.length > 0) {
                                            totalSteps += point.value[0].intVal || 0;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                
                stepsInput.value = totalSteps;
                status.innerHTML = `✅ ${totalSteps.toLocaleString()} 歩を取得しました`;
                status.className = 'google-fit-status success';
                
            } catch (error) {
                console.error('Past Google Fit fetch error:', error);
                status.textContent = '取得エラー: ' + error.message;
                status.className = 'google-fit-status error';
            }
            
            btn.classList.remove('loading');
            document.getElementById('pastGoogleFitBtnText').textContent = '選択した日の歩数を取得';
        }
        
        // 過去の記録を保存
        async function savePastRecord() {
            const dateInput = document.getElementById('pastRecordDate');
            if (!dateInput || !dateInput.value) {
                alert('日付を選択してください');
                return;
            }
            
            const recordDate = dateInput.value;
            const recordDatetime = recordDate + 'T12:00:00+09:00'; // 正午として記録
            
            let savedCount = 0;
            
            try {
                // 歩数
                const steps = parseInt(document.getElementById('pastSteps').value);
                if (steps > 0) {
                    await savePastRecordToSupabase('steps', { steps }, recordDatetime);
                    savedCount++;
                }
                
                // 朝食
                const breakfast = document.getElementById('pastBreakfast').value.trim();
                if (breakfast) {
                    await savePastRecordToSupabase('meal', { mealType: '朝食', content: breakfast }, recordDatetime);
                    savedCount++;
                }
                
                // 昼食
                const lunch = document.getElementById('pastLunch').value.trim();
                if (lunch) {
                    await savePastRecordToSupabase('meal', { mealType: '昼食', content: lunch }, recordDatetime);
                    savedCount++;
                }
                
                // 夕食
                const dinner = document.getElementById('pastDinner').value.trim();
                if (dinner) {
                    await savePastRecordToSupabase('meal', { mealType: '夕食', content: dinner }, recordDatetime);
                    savedCount++;
                }
                
                // 間食
                const snack = document.getElementById('pastSnack').value.trim();
                if (snack) {
                    await savePastRecordToSupabase('meal', { mealType: '間食', content: snack }, recordDatetime);
                    savedCount++;
                }
                
                // トレーニング
                const exerciseType = document.getElementById('pastExerciseType').value;
                if (exerciseType) {
                    const duration = parseInt(document.getElementById('pastExerciseDuration').value) || 0;
                    const memo = document.getElementById('pastExerciseMemo').value.trim();
                    await savePastRecordToSupabase('training', { 
                        exercise: exerciseType, 
                        duration, 
                        memo 
                    }, recordDatetime);
                    savedCount++;
                }
                
                // お酒
                const alcoholChoice = document.querySelector('input[name="pastAlcohol"]:checked').value;
                if (alcoholChoice === 'none') {
                    // 休肝日として記録
                    await savePastRecordToSupabase('alcohol', { 
                        isRestDay: true,
                        drinkType: 'none',
                        pureAlcohol: 0
                    }, recordDatetime);
                    savedCount++;
                } else if (alcoholChoice === 'drink') {
                    const drinkType = document.getElementById('pastDrinkType').value;
                    const ml = parseInt(document.getElementById('pastDrinkAmount').value) || 0;
                    const percent = parseFloat(document.getElementById('pastDrinkPercent').value) || 0;
                    if (ml > 0 && percent > 0) {
                        const pureAlcohol = ml * (percent / 100) * 0.8;
                        await savePastRecordToSupabase('alcohol', { 
                            drinkType, 
                            ml, 
                            percent, 
                            pureAlcohol 
                        }, recordDatetime);
                        savedCount++;
                    }
                }
                
                // 体重
                const weight = parseFloat(document.getElementById('pastWeight').value);
                if (weight > 0) {
                    await savePastRecordToSupabase('weight', { weight }, recordDatetime);
                    savedCount++;
                }
                
                // メモ
                const memo = document.getElementById('pastMemo').value.trim();
                if (memo) {
                    await savePastRecordToSupabase('other', { category: 'memo', content: memo }, recordDatetime);
                    savedCount++;
                }
                
                if (savedCount > 0) {
                    alert(`✅ ${recordDate} の記録を ${savedCount} 件保存しました！`);
                    clearPastRecordForm();
                } else {
                    alert('保存する項目がありません。何か入力してください。');
                }
                
            } catch (error) {
                console.error('Past record save error:', error);
                alert('保存エラー: ' + error.message);
            }
        }
        
        // Supabaseに過去の記録を保存
        async function savePastRecordToSupabase(recordType, data, recordDatetime) {
            const record = {
                user_id: userId,
                record_type: recordType,
                data: { ...data, isPastRecord: true },
                xp_earned: 5 // 過去の記録は5XP
            };
            
            const { error } = await supabase
                .from('health_records')
                .insert([record]);
            
            if (error) {
                throw new Error(error.message);
            }
        }
        
        // フォームをクリア
        function clearPastRecordForm() {
            document.getElementById('pastSteps').value = '';
            document.getElementById('pastBreakfast').value = '';
            document.getElementById('pastLunch').value = '';
            document.getElementById('pastDinner').value = '';
            document.getElementById('pastSnack').value = '';
            document.getElementById('pastExerciseType').value = '';
            document.getElementById('pastExerciseDuration').value = '';
            document.getElementById('pastExerciseMemo').value = '';
            document.querySelector('input[name="pastAlcohol"][value="none"]').checked = true;
            togglePastAlcoholInputs();
            document.getElementById('pastDrinkType').value = 'beer';
            document.getElementById('pastDrinkAmount').value = '';
            document.getElementById('pastDrinkPercent').value = '';
            document.getElementById('pastWeight').value = '';
            document.getElementById('pastMemo').value = '';
            document.getElementById('pastGoogleFitStatus').textContent = '';
            
            // 日付を前日に
            const dateInput = document.getElementById('pastRecordDate');
            const currentDate = new Date(dateInput.value);
            currentDate.setDate(currentDate.getDate() - 1);
            dateInput.value = currentDate.toISOString().split('T')[0];
        }

        // 初期化実行
        init();
        setupGpxUpload();
        loadReminders();
        initAnalysis();
        initPastRecordDate();
    </script>
</body>
</html>
